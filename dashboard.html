<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Tribut√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== Tema Aqua Claro ===== */
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #eef6ff;       /* fundo claro azulado */
      color: #0b1220;            /* texto principal */
    }
    .card {
      background: #ffffff;       /* cart√µes brancos */
      border: 1px solid rgba(18, 54, 100, .12);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(2, 12, 27, 0.06);
    }
    .muted { color:#556276; }
    .title { color:#0ea5e9; }     /* Cyan-500 */
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid rgba(18, 54, 100, .08); }
    th { color:#075985; font-weight:600; text-align:left; } /* Cyan-900 */
    .kpi { font-size:1.75rem; font-weight:800 }
    .chip {
      font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem;
      border:1px solid rgba(14,165,233,.35);     /* Cyan-500/35 */
      background:#e0f2fe;                        /* Cyan-100 */
      color:#075985;                              /* Cyan-900 */
    }
    a.link { color:#0284c7; text-decoration: underline; }
    .ok   { color:#059669 }   /* Emerald-600 */
    .warn { color:#b45309 }   /* Amber-700 */
    tfoot td { font-weight:700; }
    .callout {
      background:#fff; border:1px dashed rgba(18,54,100,.25);
      padding:14px; border-radius:12px; color:#334155;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold title">üìä Dashboard Tribut√°rio</h1>
    <p class="muted text-sm">Visualiza√ß√£o interativa do comparativo Simples x Presumido</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 space-y-6">

    <!-- Avisos -->
    <section id="msgBox" class="hidden">
      <div class="callout">
        <div id="msgText" class="text-sm"></div>
      </div>
    </section>

    <!-- Identifica√ß√£o -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card">
        <div class="muted text-xs">Empresa</div>
        <div id="empresaNome" class="text-lg font-semibold"></div>
        <div id="empresaCNPJ" class="muted text-xs"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Munic√≠pio</div>
        <div id="empresaMunicipio" class="text-lg font-semibold"></div>
        <div class="muted text-xs">
          <span id="empresaTipo" class="chip"></span>
          <span id="regimeAtual" class="chip ml-2"></span>
        </div>
      </div>
      <div class="card">
        <div class="muted text-xs">CNAE</div>
        <div id="empresaCNAE" class="text-lg font-semibold"></div>
        <div id="flagsCNAE" class="muted text-xs"></div>
      </div>
    </section>

    <!-- S√≥cio em outra empresa -->
    <section id="outraEmpresaSec" class="grid grid-cols-1 md:grid-cols-3 gap-4" style="display:none;">
      <div class="card md:col-span-3">
        <div class="muted text-xs">Participa√ß√£o em outra empresa</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-1">
          <div>
            <div class="muted text-xs">√â s√≥cio?</div>
            <div id="ehSocio" class="text-lg font-semibold"></div>
          </div>
          <div>
            <div class="muted text-xs">Percentual de participa√ß√£o</div>
            <div id="pctSocio" class="text-lg font-semibold"></div>
          </div>
          <div>
            <div class="muted text-xs">Faturamento anual da outra</div>
            <div id="fatOutra" class="text-lg font-semibold"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div class="card">
        <div class="muted text-xs">Base de c√°lculo (RBT12)</div>
        <div id="kpiBase" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">M√©dia mensal (derivada)</div>
        <div id="kpiMediaMensal" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Simples</div>
        <div id="kpiAliqS" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Presumido</div>
        <div id="kpiAliqP" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Regime mais vantajoso</div>
        <div id="kpiMelhor" class="kpi"></div>
        <div id="kpiEconomia" class="muted text-xs"></div>
        <div id="kpiFatorR" class="muted text-xs mt-1"></div>
      </div>
    </section>

    <!-- Gr√°ficos -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="muted text-sm mb-2">Comparativo de impostos</div>
        <canvas id="chartBarras" height="280"></canvas>
      </div>
      <div class="card">
        <div class="muted text-sm mb-2">Participa√ß√£o relativa</div>
        <canvas id="chartPizza" height="280"></canvas>
      </div>
    </section>

    <!-- Detalhamento dos Impostos por Regime -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Simples -->
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold title">Simples Nacional ‚Äî Detalhamento</h2>
          <div class="text-sm muted">Al√≠quota efetiva: <span id="simplesAliqEff" class="font-semibold"></span></div>
        </div>
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Tributo</th>
                <th>Al√≠quota</th>
                <th>Valor (R$)</th>
              </tr>
            </thead>
            <tbody id="tbSimples"></tbody>
            <tfoot>
              <tr>
                <td colspan="2">Total (Simples)</td>
                <td id="totSimples"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Presumido -->
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold title">Lucro Presumido ‚Äî Detalhamento</h2>
          <div class="text-sm muted">Al√≠quota efetiva: <span id="presumidoAliqEff" class="font-semibold"></span></div>
        </div>
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Tributo</th>
                <th>Al√≠quota</th>
                <th>Valor (R$)</th>
              </tr>
            </thead>
            <tbody id="tbPresumido"></tbody>
            <tfoot>
              <tr>
                <td colspan="2">Total (Presumido)</td>
                <td id="totPresumido"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>

    <!-- Tabela atividades -->
    <section class="card">
      <div class="muted text-sm mb-3">Separa√ß√£o por atividade</div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Atividade</th>
              <th>Receita 12m</th>
              <th>Estimativa Pr√≥x. Ano</th>
              <th>Exporta√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tbodyAtividades"></tbody>
          <tfoot>
            <tr><td colspan="4" id="totaisExport" class="pt-2 muted"></td></tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- A√ß√µes -->
    <section class="flex flex-col md:flex-row gap-3 pb-10">
      <button id="btnVoltar" class="px-4 py-2 rounded-lg bg-cyan-600/10 text-cyan-900 border border-cyan-600/30 hover:bg-cyan-600/20">‚Üê Voltar ao formul√°rio</button>
      <button id="btnLimpar" class="px-4 py-2 rounded-lg bg-rose-500/10 text-rose-900 border border-rose-500/30 hover:bg-rose-500/20">Limpar dados salvos</button>
      <button id="btnCSV" class="px-4 py-2 rounded-lg bg-emerald-500/10 text-emerald-900 border border-emerald-500/30 hover:bg-emerald-500/20">Exportar atividades (CSV)</button>
    </section>
  </main>

  <script>
    /* ===== Ambiente ===== */
    const isGithubPages = location.hostname.endsWith('github.io');
    const formURL = isGithubPages ? 'index.html' : '/form';

    /* ===== Helpers ===== */
    const brl = n => 'R$ ' + Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const pctFmt = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2}) + '%';
    function pctItem(v){
      if (v === null || v === undefined) return '‚Äî';
      const s = String(v).trim();
      if (s === '' || s.toUpperCase() === 'NA') return 'NA';
      const clean = s.replace('%','').replace(',','.');
      const num = Number(clean);
      return isNaN(num) ? s : pctFmt(num);
    }
    const safeGet = (obj, path, fallback=null) =>
      path.split('.').reduce((acc,k)=> (acc && acc[k]!=null) ? acc[k] : null, obj) ?? fallback;

    const $ = id => document.getElementById(id);
    function showMsg(text){
      $('msgText').textContent = text;
      $('msgBox').classList.remove('hidden');
    }

    /* ===== Carregar an√°lise ===== */
    let data = null;
    try {
      const saved = localStorage.getItem('analiseTributaria');
      if (saved) data = JSON.parse(saved);
    } catch(e){
      console.error('Falha ao ler analiseTributaria:', e);
    }

    if(!data){
      showMsg('Nenhuma an√°lise encontrada nesta origem. Gere os dados pelo formul√°rio e tente novamente.');
    }

    /* ===== Se ainda n√£o houver dados, cria um dummy para validar a UI (opcional) ===== */
    if(!data){
      data = {
        empresa:{nome:'Empresa Exemplo', cnpj:'‚Äî', municipio:'‚Äî', tipo:'abertura', cnae_form:'62.02-3-00',
          outra_empresa:{ eh_socio:true, percentual_participacao:25, faturamento_anual:600000 }},
        calculo:{ base_utilizada: 800000, melhor_regime: 'Simples',
          simples:{ imposto:120000, aliquota_fmt:'15,00%', itens:[
            { tributo:'IRPJ', aliquota_pct:'4.80', valor: 38400 },
            { tributo:'CSLL', aliquota_pct:'2.88', valor: 23040 },
            { tributo:'PIS/COFINS/ISS', aliquota_pct:'7.32', valor: 58560 },
          ]},
          presumido:{ imposto:150000, aliquota_fmt:'18,75%', itens:[
            { tributo:'IRPJ', aliquota_pct:'8.00', valor: 64000 },
            { tributo:'CSLL', aliquota_pct:'3.70', valor: 29600 },
            { tributo:'PIS', aliquota_pct:'0.65', valor: 5200 },
            { tributo:'COFINS', aliquota_pct:'3.00', valor: 24000 },
            { tributo:'ISS', aliquota_pct:'3.00', valor: 24000 },
          ]},
          economia_fmt: 'R$ 30.000,00'
        },
        atividades:{itens:[
          {nome:'Servi√ßos', receita_12m:500000, estimativa_proximo_ano:550000, exportacao:false},
          {nome:'Consultoria', receita_12m:300000, estimativa_proximo_ano:320000, exportacao:true},
        ], totais_exportacao:{receita_12m:300000, estimativa_prox_ano:320000, receita_12m_fmt:'R$ 300.000,00', estimativa_prox_ano_fmt:'R$ 320.000,00'}}
      };
    }

    /* ===== Cabe√ßalhos ===== */
    $('empresaNome').textContent = safeGet(data,'empresa.nome','-');
    $('empresaCNPJ').textContent = safeGet(data,'empresa.cnpj','');
    $('empresaMunicipio').textContent = safeGet(data,'empresa.municipio','-');
    $('empresaTipo').textContent = 'Tipo: ' + (safeGet(data,'empresa.tipo','-'));
    $('empresaCNAE').textContent = safeGet(data,'empresa.cnae_atual', safeGet(data,'empresa.cnae_form','-'));
    const regAtual = safeGet(data,'empresa.regime_atual', null);
    if(regAtual) $('regimeAtual').textContent = 'Regime atual: ' + regAtual;
    const imp = safeGet(data,'empresa.cnae_impeditivo_simples', null);
    $('flagsCNAE').textContent = (imp===true ? 'CNAE impeditivo ao Simples' : imp===false ? 'CNAE permitido no Simples' : '');

    /* ===== Outra empresa ===== */
    const outra = safeGet(data, 'empresa.outra_empresa', null);
    if (outra && typeof outra === 'object') {
      $('outraEmpresaSec').style.display = 'grid';
      $('ehSocio').textContent = outra.eh_socio ? 'Sim' : 'N√£o';
      $('pctSocio').textContent = outra.percentual_participacao != null ? pctFmt(outra.percentual_participacao) : '‚Äî';
      $('fatOutra').textContent = outra.faturamento_anual != null ? brl(outra.faturamento_anual) : '‚Äî';
    }

    /* ===== KPIs ===== */
    const base = Number(safeGet(data,'calculo.base_utilizada',0)) || 0;
    const mediaMensal = base / 12.0;

    $('kpiBase').textContent  = brl(base);
    $('kpiMediaMensal').textContent = brl(mediaMensal);
    $('kpiAliqS').textContent = safeGet(data,'calculo.simples.aliquota_fmt','‚Äî');
    $('kpiAliqP').textContent = safeGet(data,'calculo.presumido.aliquota_fmt','‚Äî');
    $('kpiMelhor').textContent= safeGet(data,'calculo.melhor_regime','‚Äî');
    $('kpiEconomia').textContent = 'Economia estimada: ' + safeGet(data,'calculo.economia_fmt','‚Äî');

    const fatorRFlag = safeGet(data, 'calculo.inputs_normalizados.fator_r_efetivo', null);
    if (fatorRFlag !== null) {
      $('kpiFatorR').innerHTML = fatorRFlag
        ? '<span class="ok">Fator R ‚â• 28% (encaixa em Anexo III)</span>'
        : '<span class="warn">Fator R &lt; 28% (encaixa em Anexo V)</span>';
    }

    /* ===== Gr√°ficos ===== */
    const vS = Number(safeGet(data,'calculo.simples.imposto',0)) || 0;
    const vP = Number(safeGet(data,'calculo.presumido.imposto',0)) || 0;

    try {
      const ctxBar = document.getElementById('chartBarras').getContext('2d');
      new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: ['Simples', 'Presumido'],
          datasets: [{
            label: 'Impostos (R$)',
            data: [vS, vP],
            backgroundColor: ['#06b6d4','#fb7185'],  /* cyan & rose */
            borderColor: ['#0891b2','#f43f5e'],
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => brl(c.raw) } } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') } } }
        }
      });

      const ctxPie = document.getElementById('chartPizza').getContext('2d');
      new Chart(ctxPie, {
        type: 'doughnut',
        data: {
          labels: ['Simples','Presumido'],
          datasets: [{ data:[vS,vP], backgroundColor:['#06b6d4','#fb7185'], borderColor:['#0891b2','#f43f5e'] }]
        },
        options: { plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: c => `${c.label}: ${brl(c.raw)}` } } } }
      });
    } catch(e){
      console.warn('Falha ao renderizar gr√°ficos:', e);
    }

    /* ===== Detalhamento por regime ===== */
    function fillItens(tbodyId, itens) {
      const tb = $(tbodyId);
      if (!tb) return;
      tb.innerHTML = '';
      (itens||[]).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.tributo || '-'}</td>
          <td>${pctItem(it.aliquota_pct)}</td>
          <td>${brl(it.valor || 0)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    $('simplesAliqEff').textContent = safeGet(data,'calculo.simples.aliquota_fmt','‚Äî');
    fillItens('tbSimples', safeGet(data,'calculo.simples.itens', []));
    $('totSimples').textContent = brl(vS);

    $('presumidoAliqEff').textContent = safeGet(data,'calculo.presumido.aliquota_fmt','‚Äî');
    fillItens('tbPresumido', safeGet(data,'calculo.presumido.itens', []));
    $('totPresumido').textContent = brl(vP);

    /* ===== Tabela de atividades ===== */
    const tbAtv = $('tbodyAtividades');
    const itensAtv = safeGet(data,'atividades.itens',[]) || [];
    tbAtv.innerHTML = '';
    itensAtv.forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.nome||'-'}</td>
        <td>${brl(it.receita_12m||0)}</td>
        <td>${brl(it.estimativa_proximo_ano||0)}</td>
        <td>${it.exportacao ? 'Sim':'N√£o'}</td>`;
      tbAtv.appendChild(tr);
    });
    const tot = safeGet(data,'atividades.totais_exportacao',null);
    if(tot){
      $('totaisExport').innerHTML =
        `Exporta√ß√£o (totais): 12m <b>${tot.receita_12m_fmt || brl(tot.receita_12m||0)}</b> ‚Ä¢ Pr√≥x. ano <b>${tot.estimativa_prox_ano_fmt || brl(tot.estimativa_prox_ano||0)}</b>`;
    }

    /* ===== A√ß√µes ===== */
    $('btnVoltar').addEventListener('click', ()=>{ location.href = formURL; });
    $('btnLimpar').addEventListener('click', ()=>{
      localStorage.removeItem('analiseTributaria');
      alert('Dados limpos. Voltando ao formul√°rio.');
      location.href = formURL;
    });
    $('btnCSV').addEventListener('click', ()=>{
      const rows = [['Atividade','Receita 12m','Estimativa Pr√≥x. Ano','Exporta√ß√£o']];
      itensAtv.forEach(it=> rows.push([ it.nome||'', (it.receita_12m||0), (it.estimativa_proximo_ano||0), it.exportacao?'Sim':'N√£o' ]));
      const csv = rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'atividades.csv'; a.click(); URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
