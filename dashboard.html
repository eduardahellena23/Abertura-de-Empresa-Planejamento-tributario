<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tribut√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f3f6fb; color:#0f172a; }
    .card { background:#fff; border:1px solid rgba(2,6,23,0.07); border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(2,6,23,0.06); }
    .muted { color:#64748b; }
    .title { color:#1d4ed8; }
    table { width:100%; border-collapse: collapse; }
    th,td{ padding:10px; border-bottom:1px solid rgba(2,6,23,0.06) }
    th{ color:#334155; font-weight:600; text-align:left; background:#f8fafc }
    .kpi { font-size:1.5rem; font-weight:800 }
    .chip { font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem; border:1px solid rgba(2,6,23,.12); background:#f8fafc }
    .toggle .on { background:#1d4ed8; color:#fff; }
    .btn { padding:.5rem .75rem; border-radius:.5rem; border:1px solid rgba(2,6,23,.12); background:#fff; }
    .btn:hover { background:#f8fafc; }
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold title">üìä Dashboard Tribut√°rio</h1>
        <p class="muted text-sm">Comparativo Simples Nacional √ó Lucro Presumido</p>
      </div>
      <div class="card toggle flex items-center gap-2">
        <button id="btnMensal" class="px-3 py-1 rounded-md">Mensal</button>
        <button id="btnAnual" class="px-3 py-1 rounded-md">Anual</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 space-y-6">

    <!-- Identifica√ß√£o -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card">
        <div class="muted text-xs">Empresa</div>
        <div id="empresaNome" class="text-lg font-semibold"></div>
        <div id="empresaCNPJ" class="muted text-xs"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Munic√≠pio</div>
        <div id="empresaMunicipio" class="text-lg font-semibold"></div>
        <div class="muted text-xs">
          <span id="empresaTipo" class="chip"></span>
          <span id="regimeAtual" class="chip ml-2"></span>
        </div>
      </div>
      <div class="card">
        <div class="muted text-xs">CNAE</div>
        <div id="empresaCNAE" class="text-lg font-semibold"></div>
        <div id="flagsCNAE" class="muted text-xs"></div>
        <div class="mt-2">
          <span class="muted text-xs">Anexo sugerido</span>
          <div id="chipAnexo" class="chip inline-block mt-1">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div class="card">
        <div class="muted text-xs">Per√≠odo selecionado</div>
        <div id="kpiPeriodo" class="kpi"></div>
        <div id="kpiMeses" class="muted text-xs"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Base de c√°lculo</div>
        <div id="kpiBase" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Simples</div>
        <div id="kpiAliqS" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Presumido</div>
        <div id="kpiAliqP" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Regime mais vantajoso</div>
        <div id="kpiMelhor" class="kpi"></div>
        <div id="kpiEconomia" class="muted text-xs"></div>
      </div>
    </section>

    <!-- Gr√°ficos -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="muted text-sm mb-2">Comparativo de impostos</div>
        <canvas id="chartBarras" height="280"></canvas>
      </div>
      <div class="card">
        <div class="muted text-sm mb-2">Participa√ß√£o relativa</div>
        <canvas id="chartPizza" height="280"></canvas>
      </div>
    </section>

    <!-- Tabelas detalhadas por regime -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="muted text-sm">Detalhamento ‚Äî <b>Simples Nacional</b></div>
          <div class="muted text-xs" id="sumS"></div>
        </div>
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Tributo</th>
                <th>Al√≠quota</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbodySimples"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="muted text-sm">Detalhamento ‚Äî <b>Lucro Presumido</b></div>
          <div class="muted text-xs" id="sumP"></div>
        </div>
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Tributo</th>
                <th>Al√≠quota</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbodyPresumido"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Separa√ß√£o por atividade (existente) -->
    <section class="card">
      <div class="muted text-sm mb-3">Separa√ß√£o por atividade</div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Atividade</th>
              <th>Receita 12m</th>
              <th>Estimativa Pr√≥x. Ano</th>
              <th>Exporta√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tbodyAtividades"></tbody>
          <tfoot>
            <tr><td colspan="4" id="totaisExport" class="pt-2 muted"></td></tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- NOVO: CNAEs (principal + secund√°rios) com bot√£o Abrir -->
    <section class="card">
      <div class="flex items-center justify-between">
        <div class="muted text-sm mb-3">CNAEs (principal + secund√°rios)</div>
        <div class="muted text-xs" id="hintCnaes">Carregando...</div>
      </div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:120px;">CNAE</th>
              <th>Descri√ß√£o</th>
              <th style="min-width:110px;">Anexo sugerido</th>
              <th style="min-width:120px;">Simples (R$)</th>
              <th style="min-width:140px;">Presumido (R$)</th>
              <th style="min-width:120px;">A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tbodyCnaes"></tbody>
        </table>
      </div>
    </section>

    <!-- A√ß√µes -->
    <section class="flex flex-col md:flex-row gap-3 pb-10">
      <button id="btnVoltar" class="px-4 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50">‚Üê Voltar ao formul√°rio</button>
      <button id="btnLimpar" class="px-4 py-2 rounded-lg bg-rose-50 text-rose-700 border border-rose-200 hover:bg-rose-100">Limpar dados salvos</button>
      <button id="btnCSV" class="px-4 py-2 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100">Exportar atividades (CSV)</button>
    </section>
  </main>

  <script>
    // ====== CONFIG
    const apiUrlBase = "http://127.0.0.1:8000";

    // ====== Helpers
    const brl = n => 'R$ ' + Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const pct = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2}) + '%';
    const safeGet = (obj, path, fallback=null)=> path.split('.').reduce((acc,k)=> (acc && acc[k]!=null) ? acc[k] : null, obj) ?? fallback;
    const sumItens = (itens) => (itens || []).reduce((s, it) => s + Number(it?.valor || 0), 0);
    const hasCPP = (itens) => (itens || []).some(it => String(it?.tributo || '').toUpperCase().startsWith('CPP'));
    const aliqFmtOr = (blocoReg, base) => {
      const txt = blocoReg?.aliquota_fmt || blocoReg?.aliquota_efetiva_pct;
      if (txt != null && txt !== '') return String(txt).includes('%') ? String(txt) : pct(txt);
      const total = Number(blocoReg?.imposto ?? 0) || sumItens(blocoReg?.itens);
      return base > 0 ? pct((total / base) * 100) : '‚Äî';
    };

    // ====== Carrega an√°lise principal
    let data = null;
    (function load(){
      try {
        const saved = localStorage.getItem('analiseTributaria');
        if (!saved) throw new Error('Sem dados');
        data = JSON.parse(saved);
      } catch(e){
        alert('Nenhuma an√°lise encontrada. Volte ao formul√°rio para gerar os dados.');
        location.href = '/form';
      }
    })();

    // ====== Estado (mensal/anual)
    const hasNew = data && data.calculos && (data.calculos.mensal || data.calculos.anual);
    let periodo = (hasNew ? (data.periodo_padrao || (data.calculos.anual ? 'anual':'mensal')) : 'legacy');

    // ====== Cabe√ßalhos fixos
    document.getElementById('empresaNome').textContent = safeGet(data,'empresa.nome','-');
    document.getElementById('empresaCNPJ').textContent = safeGet(data,'empresa.cnpj','');
    document.getElementById('empresaMunicipio').textContent = safeGet(data,'empresa.municipio','-');
    document.getElementById('empresaTipo').textContent = 'Tipo: ' + (safeGet(data,'empresa.tipo','-'));
    document.getElementById('empresaCNAE').textContent = safeGet(data,'empresa.cnae_atual', safeGet(data,'empresa.cnae_form','-'));
    const regAtual = safeGet(data,'empresa.regime_atual', null);
    if(regAtual) document.getElementById('regimeAtual').textContent = 'Regime atual: ' + regAtual;
    const imp = safeGet(data,'empresa.cnae_impeditivo_simples', null);
    document.getElementById('flagsCNAE').textContent = (imp===true ? 'CNAE impeditivo ao Simples' : imp===false ? 'CNAE permitido no Simples' : '');

    // ====== Toggle UI
    const btnMensal = document.getElementById('btnMensal');
    const btnAnual  = document.getElementById('btnAnual');
    function paintToggle(){
      btnMensal.classList.toggle('on', periodo==='mensal');
      btnAnual.classList.toggle('on',  periodo==='anual');
      const disabled = !hasNew;
      btnMensal.disabled = disabled; btnAnual.disabled = disabled;
      if(disabled){ btnMensal.title = btnAnual.title = 'Resposta antiga (sem mensal/anual)'; }
    }
    btnMensal.addEventListener('click', ()=>{ if(hasNew){ periodo='mensal'; render(); renderCnaesTable(); } });
    btnAnual .addEventListener('click', ()=>{ if(hasNew){ periodo='anual';  render(); renderCnaesTable(); } });

    // ====== Charts
    let barChart=null, pieChart=null;
    function setBarChart(vS, vP){
      const ctx = document.getElementById('chartBarras').getContext('2d');
      if(barChart){ barChart.destroy(); }
      barChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: ['Simples', 'Presumido'],
          datasets: [{ label: 'Impostos (R$)', data: [vS, vP], borderWidth: 1 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => brl(c.raw) } } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') } } }
        }
      });
    }
    function setPieChart(vS, vP){
      const ctx = document.getElementById('chartPizza').getContext('2d');
      if(pieChart){ pieChart.destroy(); }
      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Simples','Presumido'], datasets: [{ data:[vS,vP] }] },
        options: { plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: c => `${c.label}: ${brl(c.raw)}` } } } }
      });
    }

    function renderTable(tbodyId, itens){
      const tb = document.getElementById(tbodyId);
      tb.innerHTML = '';
      (itens||[]).forEach(it=>{
        const tr = document.createElement('tr');
        const aliq = it.aliquota_pct;
        const aliqFmt = (aliq==null || aliq==='NA') ? '‚Äî' :
                        (String(aliq).includes('%') ? String(aliq) : (String(aliq).replace('.',',')) + '%');
        tr.innerHTML = `
          <td>${it.tributo||'-'}</td>
          <td>${aliqFmt}</td>
          <td>${brl(it.valor)}</td>`;
        tb.appendChild(tr);
      });
    }

    // ====== Render principal
    function render(){
      paintToggle();

      let bloco = null, base = 0, labelPeriodo='‚Äî', mesesInfo='';
      if (hasNew) {
        bloco = data.calculos[periodo];

        const baseFromBloco = bloco?.base_utilizada;           // PRIORIDADE
        const baseMensal = data?.bases?.mensal ?? null;
        const baseAnual  = data?.bases?.anual  ?? null;
        const legacyBase = data?.calculo?.base_utilizada ?? null;

        if (periodo === 'mensal') {
          base = (baseFromBloco ?? baseMensal ?? (legacyBase!=null ? legacyBase/12 : 0));
          labelPeriodo = 'Mensal';
          mesesInfo = `(${bloco?.periodo_meses || 1} meses)`;
          if (baseAnual && base && base > baseAnual) base = baseAnual/12; // sanity
        } else {
          base = (baseFromBloco ?? baseAnual ?? (legacyBase ?? 0));
          labelPeriodo = 'Anual';
          mesesInfo = `(${bloco?.periodo_meses || 12} meses)`;
        }
      } else {
        // legado: s√≥ anual
        bloco = data.calculo;
        base  = data?.calculo?.base_utilizada ?? 0;
        labelPeriodo = 'Anual (compat)';
        mesesInfo = `(${data?.calculo?.periodo_meses || 12} meses)`;
      }

      // Chip Anexo
      const anexoAtual = bloco?.anexo || data?.calculo?.anexo || '‚Äî';
      document.getElementById('chipAnexo').textContent = anexoAtual || '‚Äî';

      // KPIs
      const totalS = Number(bloco?.simples?.imposto ?? 0) || sumItens(bloco?.simples?.itens);
      const totalP = Number(bloco?.presumido?.imposto ?? 0) || sumItens(bloco?.presumido?.itens);

      const aliqS = aliqFmtOr(bloco?.simples, base);
      const aliqP = aliqFmtOr(bloco?.presumido, base);

      document.getElementById('kpiPeriodo').textContent = labelPeriodo;
      document.getElementById('kpiMeses').textContent   = mesesInfo;
      document.getElementById('kpiBase').textContent    = brl(base);
      document.getElementById('kpiAliqS').textContent   = aliqS;
      document.getElementById('kpiAliqP').textContent   = aliqP;
      document.getElementById('kpiMelhor').textContent  = bloco?.melhor_regime || '‚Äî';
      document.getElementById('kpiEconomia').textContent= 'Economia estimada: ' + (bloco?.economia_fmt || '‚Äî');

      // Gr√°ficos
      setBarChart(totalS, totalP);
      setPieChart(totalS, totalP);

      // Tabelas detalhadas
      renderTable('tbodySimples',   bloco?.simples?.itens || []);
      renderTable('tbodyPresumido', bloco?.presumido?.itens || []);

      // Rodap√©s + nota sobre CPP
      const notaCPP_S = hasCPP(bloco?.simples?.itens) ? ' ‚Ä¢ inclui CPP' + ((anexoAtual||'')==='IV' ? ' (Anexo IV)' : '') : '';
      const notaCPP_P = hasCPP(bloco?.presumido?.itens) ? ' ‚Ä¢ inclui CPP' : '';

      document.getElementById('sumS').textContent = `Total: ${brl(totalS)} ‚Ä¢ Al√≠quota: ${aliqS}${notaCPP_S}`;
      document.getElementById('sumP').textContent = `Total: ${brl(totalP)} ‚Ä¢ Al√≠quota: ${aliqP}${notaCPP_P}`;

      // Atividades (se tiver)
      const tbAtv = document.getElementById('tbodyAtividades');
      const itens = safeGet(data,'atividades.itens',[]) || [];
      tbAtv.innerHTML = '';
      itens.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.nome||'-'}</td>
          <td>${brl(it.receita_12m||0)}</td>
          <td>${brl(it.estimativa_proximo_ano||0)}</td>
          <td>${it.exportacao ? 'Sim':'N√£o'}</td>`;
        tbAtv.appendChild(tr);
      });
      const tot = safeGet(data,'atividades.totais_exportacao',null);
      if(tot){
        document.getElementById('totaisExport').innerHTML =
          `Exporta√ß√£o (totais): 12m <b>${tot.receita_12m_fmt || brl(tot.receita_12m||0)}</b> ‚Ä¢ Pr√≥x. ano <b>${tot.estimativa_prox_ano_fmt || brl(tot.estimativa_prox_ano||0)}</b>`;
      }
    }

    // ====== NOVO: Tabela de CNAEs (principal + secund√°rios)
    const cnaesCache = new Map(); // codigo -> { cnaeInfo, analise: {mensal, anual} }
    function getUltimoPayload(){
      try { return JSON.parse(localStorage.getItem('ultimoPayload') || '{}'); }
      catch { return {}; }
    }
    function normalizeArrayCnaes(rawList){
      if(!rawList) return [];
      return rawList.map(s => String(s||'').trim()).filter(Boolean);
    }

    async function fetchCnaeInfo(codigo, rbt12, folha12){
      const url = `${apiUrlBase}/cnae/${encodeURIComponent(codigo)}?rbt12=${Number(rbt12||0)}&folha12=${Number(folha12||0)}`;
      const resp = await fetch(url);
      if(!resp.ok) throw new Error(await resp.text() || 'Erro ao consultar CNAE');
      return resp.json();
    }

    async function fetchAnaliseForCnae(payloadBase, codigo, anexoSug){
      const p = { ...payloadBase, cnae: codigo, anexo: anexoSug || payloadBase.anexo };
      const resp = await fetch(`${apiUrlBase}/analise`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(p)
      });
      if(!resp.ok) throw new Error(await resp.text() || 'Erro ao analisar CNAE');
      return resp.json();
    }

    function totalFromBloco(bloco){
      if(!bloco) return { simples: 0, presumido: 0 };
      const S = Number(bloco?.simples?.imposto ?? 0) || sumItens(bloco?.simples?.itens);
      const P = Number(bloco?.presumido?.imposto ?? 0) || sumItens(bloco?.presumido?.itens);
      return { simples: S, presumido: P };
    }

    async function renderCnaesTable(){
      const tbody = document.getElementById('tbodyCnaes');
      const hint  = document.getElementById('hintCnaes');
      tbody.innerHTML = '';
      hint.textContent = 'Carregando...';

      const ultimo = getUltimoPayload();
      const principal = safeGet(data,'empresa.cnae_form', null) || safeGet(data,'empresa.cnae_atual', null);
      const secundarios = normalizeArrayCnaes(ultimo?.cnaes_secundarios || []);
      const todos = [principal, ...secundarios].filter(Boolean);

      if(todos.length === 0){
        hint.textContent = 'Nenhum CNAE informado.';
        return;
      }

      // bases para consulta/an√°lise
      const rbt12 = safeGet(data,'bases.anual', 0);
      const folhaMensal = ultimo?.folha || 0;
      const folha12 = (Number(folhaMensal)||0) * 12;

      // payload base para /analise
      const payloadBase = {
        nome_empresa: ultimo?.nome_empresa || safeGet(data,'empresa.nome',''),
        cnpj: ultimo?.cnpj || safeGet(data,'empresa.cnpj',''),
        tipo_empresa: ultimo?.tipo_empresa || (safeGet(data,'empresa.tipo','abertura') === 'abertura' ? 'abertura' : 'constituida'),
        municipio: ultimo?.municipio || safeGet(data,'empresa.municipio',''),

        rbt12: rbt12,
        faturamento_mensal: safeGet(data,'bases.mensal', 0),

        // legado/compat
        faturamento: 0,

        socio_outra_empresa: ultimo?.socio_outra_empresa || 'nao',
        socio_outra_empresa_percentual: ultimo?.socio_outra_empresa_percentual || 0,
        socio_outra_empresa_faturamento_anual: ultimo?.socio_outra_empresa_faturamento_anual || 0,

        // estes ser√£o trocados por CNAE/Anexo a cada linha
        cnae: principal || '',
        prolabore: ultimo?.prolabore || safeGet(data,'prolabore',0) || 0,
        anexo: ultimo?.anexo || safeGet(data, 'calculo.anexo',''),
        comparar: ultimo?.comparar || safeGet(data,'comparar','Ambos'),
        prolabore_ideal: ultimo?.prolabore_ideal || 0,
        tem_funcionarios: ultimo?.tem_funcionarios || 'nao',
        folha: ultimo?.folha || 0,
        folha_12m_total: folha12
      };

      // carregar linhas em s√©rie (mais simples) ‚Äî se quiser, d√° pra paralelizar
      for(const codigo of todos){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><code>${codigo}</code></td>
          <td class="muted">‚Äî</td>
          <td>‚Äî</td>
          <td>‚Äî</td>
          <td>‚Äî</td>
          <td><button class="btn" disabled>Carregando...</button></td>`;
        tbody.appendChild(tr);

        try{
          // cache?
          let entry = cnaesCache.get(codigo);
          if(!entry){
            // 1) info do CNAE (sugest√£o de anexo)
            const info = await fetchCnaeInfo(codigo, rbt12, folha12).catch(()=>null);

            // 2) an√°lises mensal e anual (pra alternar sem recarregar)
            const analiseAnual  = await fetchAnaliseForCnae(payloadBase, codigo, info?.sugestao_anexo || payloadBase.anexo);
            // refaz para mensal trocando o "periodo" por base mensal (j√° enviamos faturamento_mensal em payloadBase)
            // o endpoint j√° retorna ambos (mensal e anual) ‚Äî √≥timo, usamos do pr√≥prio retorno.
            entry = { cnaeInfo: info, analise: analiseAnual };
            cnaesCache.set(codigo, entry);
          }

          const info = entry.cnaeInfo;
          const analise = entry.analise;

          // pega o bloco do per√≠odo atual
          const bloco = hasNew ? analise.calculos[periodo] : analise.calculo;
          const { simples, presumido } = totalFromBloco(bloco);

          const descricao = info?.descricao || '‚Äî';
          const anexo = info?.sugestao_anexo || (bloco?.anexo || '‚Äî');

          tr.children[1].textContent = descricao;
          tr.children[2].textContent = anexo || '‚Äî';
          tr.children[3].textContent = brl(simples);
          tr.children[4].textContent = brl(presumido);

          const btn = tr.children[5].querySelector('button');
          btn.disabled = false;
          btn.textContent = 'Abrir CNAE';
          btn.addEventListener('click', async ()=>{
            try{
              // Podemos reaproveitar a an√°lise j√° feita pra esse CNAE:
              localStorage.setItem('analiseTributaria', JSON.stringify(analise));
              // Tamb√©m atualizar ultimoPayload com o CNAE escolhido como "atual"
              const up = getUltimoPayload();
              up.cnae = codigo;
              up.anexo = anexo;
              localStorage.setItem('ultimoPayload', JSON.stringify(up));
              location.reload(); // recarrega o dashboard com esse CNAE
            }catch(e){
              alert('N√£o foi poss√≠vel abrir o CNAE selecionado.');
            }
          });

        }catch(err){
          tr.children[1].textContent = '‚Äî';
          tr.children[2].textContent = '‚Äî';
          tr.children[3].textContent = '‚Äî';
          tr.children[4].textContent = '‚Äî';
          const btn = tr.children[5].querySelector('button');
          btn.textContent = 'Abrir CNAE';
          btn.disabled = true;
          console.warn('Falha CNAE', codigo, err);
        }
      }

      const principal = safeGet(data,'empresa.cnae_form', null) || safeGet(data,'empresa.cnae_atual', null);
      const secundarios = normalizeArrayCnaes((getUltimoPayload()?.cnaes_secundarios)||[]);
      document.getElementById('hintCnaes').textContent = `Principal: ${principal || '‚Äî'} ‚Ä¢ Secund√°rios: ${secundarios.length}`;
    }

    // ====== A√ß√µes gerais
    document.getElementById('btnVoltar').addEventListener('click', ()=>{ location.href = '/form'; });
    document.getElementById('btnLimpar').addEventListener('click', ()=>{
      localStorage.removeItem('analiseTributaria');
      localStorage.removeItem('ultimoPayload');
      alert('Dados limpos. Voltando ao formul√°rio.');
      location.href = '/form';
    });
    document.getElementById('btnCSV').addEventListener('click', ()=>{
      const itens = (data?.atividades?.itens)||[];
      const rows = [['Atividade','Receita 12m','Estimativa Pr√≥x. Ano','Exporta√ß√£o']];
      itens.forEach(it=> rows.push([ it.nome||'', (it.receita_12m||0), (it.estimativa_proximo_ano||0), it.exportacao?'Sim':'N√£o' ]));
      const csv = rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'atividades.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    // ====== Start
    render();
    renderCnaesTable();
  <script>
  // ===== CONFIG
  const apiUrlBase = "http://127.0.0.1:8000";

  // Helpers b√°sicos j√° usados no HTML
  const brl = n => 'R$ ' + Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  const pct = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2}) + '%';
  const safeGet = (obj, path, fallback=null)=> path.split('.').reduce((acc,k)=> (acc && acc[k]!=null) ? acc[k] : null, obj) ?? fallback;
  const sumItens = (itens) => (itens || []).reduce((s, it) => s + Number(it?.valor || 0), 0);
  const hasCPP = (itens) => (itens || []).some(it => String(it?.tributo || '').toUpperCase().startsWith('CPP'));
  const aliqFmtOr = (blocoReg, base) => {
    const txt = blocoReg?.aliquota_fmt || blocoReg?.aliquota_efetiva_pct;
    if (txt != null && txt !== '') return String(txt).includes('%') ? String(txt) : pct(txt);
    const total = Number(blocoReg?.imposto ?? 0) || sumItens(blocoReg?.itens);
    return base > 0 ? pct((total / base) * 100) : '‚Äî';
  };

  // ========== CARGA DE DADOS (com auto-fetch se n√£o houver localStorage) ==========
  let data = null;

  async function ensureData() {
    try {
      const saved = localStorage.getItem('analiseTributaria');
      if (saved) { data = JSON.parse(saved); return true; }

      // tenta regenerar usando o √∫ltimo payload salvo no form
      const payloadStr = localStorage.getItem('ultimoPayload');
      if (!payloadStr) return false;

      // mostra feedback simples na tela
      showToast('Gerando an√°lise automaticamente‚Ä¶', 2500);

      const resp = await fetch(`${apiUrlBase}/analise`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: payloadStr
      });
      if (!resp.ok) return false;

      data = await resp.json();
      localStorage.setItem('analiseTributaria', JSON.stringify(data));
      return true;
    } catch (e) {
      console.error('[dashboard] ensureData error:', e);
      return false;
    }
  }

  // ========== UI auxiliar ==========
  function showToast(msg, ms=2000){
    let n = document.getElementById('__toast__');
    if(!n){
      n = document.createElement('div');
      n.id='__toast__';
      n.style.position='fixed';
      n.style.right='16px';
      n.style.bottom='16px';
      n.style.zIndex='9999';
      n.style.padding='10px 14px';
      n.style.borderRadius='10px';
      n.style.background='#1d4ed8';
      n.style.color='#fff';
      n.style.boxShadow='0 6px 20px rgba(2,6,23,.18)';
      document.body.appendChild(n);
    }
    n.textContent = msg;
    n.style.display='block';
    setTimeout(()=>{ n.style.display='none'; }, ms);
  }

  // ========== RENDER ==========
  let barChart=null, pieChart=null;

  function setBarChart(vS, vP){
    const ctx = document.getElementById('chartBarras')?.getContext('2d');
    if (!ctx) return;
    if(barChart){ barChart.destroy(); }
    barChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: ['Simples', 'Presumido'],
        datasets: [{ label: 'Impostos (R$)', data: [vS, vP], borderWidth: 1 }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => brl(c.raw) } } },
        scales: { y: { beginAtZero: true, ticks: { callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') } } }
      }
    });
  }
  function setPieChart(vS, vP){
    const ctx = document.getElementById('chartPizza')?.getContext('2d');
    if (!ctx) return;
    if(pieChart){ pieChart.destroy(); }
    pieChart = new Chart(ctx, {
      type: 'doughnut',
      data: { labels: ['Simples','Presumido'], datasets: [{ data:[vS,vP] }] },
      options: { plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: c => `${c.label}: ${brl(c.raw)}` } } } }
    });
  }
  function renderTable(tbodyId, itens){
    const tb = document.getElementById(tbodyId);
    if(!tb) return;
    tb.innerHTML = '';
    (itens||[]).forEach(it=>{
      const tr = document.createElement('tr');
      const aliq = it.aliquota_pct;
      const aliqFmt = (aliq==null || aliq==='NA') ? '‚Äî' :
                      (String(aliq).includes('%') ? String(aliq) : (String(aliq).replace('.',',')) + '%');
      tr.innerHTML = `
        <td>${it.tributo||'-'}</td>
        <td>${aliqFmt}</td>
        <td>${brl(it.valor)}</td>`;
      tb.appendChild(tr);
    });
  }

  function paintToggle(periodo, hasNew){
    const btnMensal = document.getElementById('btnMensal');
    const btnAnual  = document.getElementById('btnAnual');
    if(!btnMensal || !btnAnual) return;

    btnMensal.classList.toggle('on', periodo==='mensal');
    btnAnual.classList.toggle('on',  periodo==='anual');

    const disabled = !hasNew;
    btnMensal.disabled = disabled; btnAnual.disabled = disabled;
    if(disabled){ btnMensal.title = btnAnual.title = 'Resposta antiga (sem mensal/anual)'; }
  }

  function render(){
    // estado (mensal/anual)
    const hasNew = data && data.calculos && (data.calculos.mensal || data.calculos.anual);
    let periodo = (hasNew ? (data.periodo_padrao || (data.calculos.anual ? 'anual':'mensal')) : 'legacy');

    // listeners toggle
    document.getElementById('btnMensal')?.addEventListener('click', ()=>{ if(hasNew){ periodo='mensal'; draw(periodo, hasNew); } });
    document.getElementById('btnAnual') ?.addEventListener('click', ()=>{ if(hasNew){ periodo='anual';  draw(periodo, hasNew); } });

    draw(periodo, hasNew);
  }

  function draw(periodo, hasNew){
    paintToggle(periodo, hasNew);

    // Cabe√ßalhos fixos
    document.getElementById('empresaNome').textContent = safeGet(data,'empresa.nome','-');
    document.getElementById('empresaCNPJ').textContent = safeGet(data,'empresa.cnpj','');
    document.getElementById('empresaMunicipio').textContent = safeGet(data,'empresa.municipio','-');
    document.getElementById('empresaTipo').textContent = 'Tipo: ' + (safeGet(data,'empresa.tipo','-'));
    document.getElementById('empresaCNAE').textContent = safeGet(data,'empresa.cnae_atual', safeGet(data,'empresa.cnae_form','-'));

    const regAtual = safeGet(data,'empresa.regime_atual', null);
    if(regAtual) document.getElementById('regimeAtual').textContent = 'Regime atual: ' + regAtual;
    const imp = safeGet(data,'empresa.cnae_impeditivo_simples', null);
    document.getElementById('flagsCNAE').textContent = (imp===true ? 'CNAE impeditivo ao Simples' : imp===false ? 'CNAE permitido no Simples' : '');

    // Bloco e base
    let bloco = null, base = 0, labelPeriodo='‚Äî', mesesInfo='';
    if (hasNew) {
      bloco = data.calculos[periodo];
      const baseFromBloco = bloco?.base_utilizada;
      const baseMensal = data?.bases?.mensal ?? null;
      const baseAnual  = data?.bases?.anual  ?? null;
      const legacyBase = data?.calculo?.base_utilizada ?? null;

      if (periodo === 'mensal') {
        base = (baseFromBloco ?? baseMensal ?? (legacyBase!=null ? legacyBase/12 : 0));
        labelPeriodo = 'Mensal';
        mesesInfo = `(${bloco?.periodo_meses || 1} meses)`;
        if (baseAnual && base && base > baseAnual) base = baseAnual/12;
      } else {
        base = (baseFromBloco ?? baseAnual ?? (legacyBase ?? 0));
        labelPeriodo = 'Anual';
        mesesInfo = `(${bloco?.periodo_meses || 12} meses)`;
      }
    } else {
      bloco = data.calculo;
      base  = data?.calculo?.base_utilizada ?? 0;
      labelPeriodo = 'Anual (compat)';
      mesesInfo = `(${data?.calculo?.periodo_meses || 12} meses)`;
    }

    // Chip Anexo
    const anexoAtual = bloco?.anexo || data?.calculo?.anexo || '‚Äî';
    document.getElementById('chipAnexo').textContent = anexoAtual || '‚Äî';

    // KPIs
    const totalS = Number(bloco?.simples?.imposto ?? 0) || sumItens(bloco?.simples?.itens);
    const totalP = Number(bloco?.presumido?.imposto ?? 0) || sumItens(bloco?.presumido?.itens);
    const aliqS = aliqFmtOr(bloco?.simples, base);
    const aliqP = aliqFmtOr(bloco?.presumido, base);

    document.getElementById('kpiPeriodo').textContent = labelPeriodo;
    document.getElementById('kpiMeses').textContent   = mesesInfo;
    document.getElementById('kpiBase').textContent    = brl(base);
    document.getElementById('kpiAliqS').textContent   = aliqS;
    document.getElementById('kpiAliqP').textContent   = aliqP;
    document.getElementById('kpiMelhor').textContent  = bloco?.melhor_regime || '‚Äî';
    document.getElementById('kpiEconomia').textContent= 'Economia estimada: ' + (bloco?.economia_fmt || '‚Äî');

    // Gr√°ficos
    setBarChart(totalS, totalP);
    setPieChart(totalS, totalP);

    // Tabelas detalhadas
    renderTable('tbodySimples',   bloco?.simples?.itens || []);
    renderTable('tbodyPresumido', bloco?.presumido?.itens || []);

    // Rodap√©s + nota sobre CPP
    const notaCPP_S = hasCPP(bloco?.simples?.itens) ? ' ‚Ä¢ inclui CPP' + (anexoAtual==='IV' ? ' (Anexo IV)' : '') : '';
    const notaCPP_P = hasCPP(bloco?.presumido?.itens) ? ' ‚Ä¢ inclui CPP' : '';
    document.getElementById('sumS').textContent = `Total: ${brl(totalS)} ‚Ä¢ Al√≠quota: ${aliqS}${notaCPP_S}`;
    document.getElementById('sumP').textContent = `Total: ${brl(totalP)} ‚Ä¢ Al√≠quota: ${aliqP}${notaCPP_P}`;

    // Atividades (se existirem)
    const tbAtv = document.getElementById('tbodyAtividades');
    if (tbAtv) {
      const itens = safeGet(data,'atividades.itens',[]) || [];
      tbAtv.innerHTML = '';
      itens.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.nome||'-'}</td>
          <td>${brl(it.receita_12m||0)}</td>
          <td>${brl(it.estimativa_proximo_ano||0)}</td>
          <td>${it.exportacao ? 'Sim':'N√£o'}</td>`;
        tbAtv.appendChild(tr);
      });
      const tot = safeGet(data,'atividades.totais_exportacao',null);
      if(tot){
        const el = document.getElementById('totaisExport');
        if (el) el.innerHTML =
          `Exporta√ß√£o (totais): 12m <b>${tot.receita_12m_fmt || brl(tot.receita_12m||0)}</b> ‚Ä¢ Pr√≥x. ano <b>${tot.estimativa_prox_ano_fmt || brl(tot.estimativa_prox_ano||0)}</b>`;
      }
    }

    // Bot√µes a√ß√£o
    document.getElementById('btnVoltar')?.addEventListener('click', ()=>{ location.href = '/form'; });
    document.getElementById('btnLimpar')?.addEventListener('click', ()=>{
      localStorage.removeItem('analiseTributaria');
      localStorage.removeItem('ultimoPayload');
      alert('Dados limpos. Voltando ao formul√°rio.');
      location.href = '/form';
    });
    document.getElementById('btnCSV')?.addEventListener('click', ()=>{
      const itens = (data?.atividades?.itens)||[];
      const rows = [['Atividade','Receita 12m','Estimativa Pr√≥x. Ano','Exporta√ß√£o']];
      itens.forEach(it=> rows.push([ it.nome||'', (it.receita_12m||0), (it.estimativa_proximo_ano||0), it.exportacao?'Sim':'N√£o' ]));
      const csv = rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'atividades.csv'; a.click(); URL.revokeObjectURL(a.href);
    });
  }

  // Boot
  window.addEventListener('DOMContentLoaded', async ()=>{
    const ok = await ensureData();
    if (!ok) {
      alert('N√£o encontrei dados para o dashboard. Volte ao formul√°rio e gere a an√°lise.');
      location.href = '/form';
      return;
    }
    render();
  });
</script>

</body>
</html>

