<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tribut√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f3f6fb; color:#0f172a; }
    .card { background:#fff; border:1px solid rgba(2,6,23,0.07); border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(2,6,23,0.06); }
    .muted { color:#64748b; }
    .title { color:#1d4ed8; }
    table { width:100%; border-collapse: collapse; }
    th,td{ padding:10px; border-bottom:1px solid rgba(2,6,23,0.06) }
    th{ color:#334155; font-weight:600; text-align:left; background:#f8fafc }
    .kpi { font-size:1.5rem; font-weight:800 }
    .chip { font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem; border:1px solid rgba(2,6,23,.12); background:#f8fafc }
    .toggle .on { background:#1d4ed8; color:#fff; }
    .btn-slim { padding:.35rem .6rem; border:1px solid rgba(2,6,23,.12); border-radius:.5rem; background:#fff; }
    .btn-slim:hover { background:#f8fafc; }
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold title">üìä Dashboard Tribut√°rio</h1>
        <p class="muted text-sm">Comparativo Simples Nacional √ó Lucro Presumido</p>
      </div>
      <div class="card toggle flex items-center gap-2">
        <button id="btnMensal" class="px-3 py-1 rounded-md">Mensal</button>
        <button id="btnAnual" class="px-3 py-1 rounded-md">Anual</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 space-y-6">

    <!-- Identifica√ß√£o -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card">
        <div class="muted text-xs">Empresa</div>
        <div id="empresaNome" class="text-lg font-semibold"></div>
        <div id="empresaCNPJ" class="muted text-xs"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Munic√≠pio</div>
        <div id="empresaMunicipio" class="text-lg font-semibold"></div>
        <div class="muted text-xs">
          <span id="empresaTipo" class="chip"></span>
          <span id="regimeAtual" class="chip ml-2"></span>
        </div>
      </div>
      <div class="card">
        <div class="muted text-xs">CNAE em exibi√ß√£o</div>
        <div id="empresaCNAE" class="text-lg font-semibold"></div>
        <div id="flagsCNAE" class="muted text-xs"></div>
        <div class="mt-2">
          <span class="muted text-xs">Anexo</span>
          <div id="chipAnexo" class="chip inline-block mt-1">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div class="card">
        <div class="muted text-xs">Per√≠odo selecionado</div>
        <div id="kpiPeriodo" class="kpi"></div>
        <div id="kpiMeses" class="muted text-xs"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Base de c√°lculo</div>
        <div id="kpiBase" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Simples</div>
        <div id="kpiAliqS" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Presumido</div>
        <div id="kpiAliqP" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Regime mais vantajoso</div>
        <div id="kpiMelhor" class="kpi"></div>
        <div id="kpiEconomia" class="muted text-xs"></div>
      </div>
    </section>

    <!-- Gr√°ficos -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="muted text-sm mb-2">Comparativo de impostos</div>
        <canvas id="chartBarras" height="280"></canvas>
      </div>
      <div class="card">
        <div class="muted text-sm mb-2">Participa√ß√£o relativa</div>
        <canvas id="chartPizza" height="280"></canvas>
      </div>
    </section>

    <!-- Tabelas detalhadas por regime -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="muted text-sm">Detalhamento ‚Äî <b>Simples Nacional</b></div>
          <div class="muted text-xs" id="sumS"></div>
        </div>
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Tributo</th>
                <th>Al√≠quota</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbodySimples"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="muted text-sm">Detalhamento ‚Äî <b>Lucro Presumido</b></div>
          <div class="muted text-xs" id="sumP"></div>
        </div>
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Tributo</th>
                <th>Al√≠quota</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbodyPresumido"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CNAEs: principal + secund√°rios -->
    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <div class="muted text-sm">CNAEs ‚Äî principal e secund√°rios</div>
        <div class="muted text-xs">Clique em ‚ÄúAbrir CNAE‚Äù para ver o dashboard completo daquele CNAE</div>
      </div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:150px">CNAE</th>
              <th>Descri√ß√£o</th>
              <th>Anexo</th>
              <th>Simples (R$)</th>
              <th>Presumido (R$)</th>
              <th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tbodyCnaes"></tbody>
        </table>
      </div>
    </section>

    <!-- Tabela atividades (separa√ß√£o informada no form) -->
    <section class="card">
      <div class="muted text-sm mb-3">Separa√ß√£o por atividade</div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Atividade</th>
              <th>Receita 12m</th>
              <th>Estimativa Pr√≥x. Ano</th>
              <th>Exporta√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tbodyAtividades"></tbody>
          <tfoot>
            <tr><td colspan="4" id="totaisExport" class="pt-2 muted"></td></tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- A√ß√µes -->
    <section class="flex flex-col md:flex-row gap-3 pb-10">
      <button id="btnVoltar" class="px-4 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50">‚Üê Voltar ao formul√°rio</button>
      <button id="btnLimpar" class="px-4 py-2 rounded-lg bg-rose-50 text-rose-700 border border-rose-200 hover:bg-rose-100">Limpar dados salvos</button>
      <button id="btnCSV" class="px-4 py-2 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100">Exportar atividades (CSV)</button>
    </section>
  </main>

  <script>
    // ===== Helpers
    const brl = n => 'R$ ' + Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const pct = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2}) + '%';
    const safeGet = (obj, path, fallback=null)=> path.split('.').reduce((acc,k)=> (acc && acc[k]!=null) ? acc[k] : null, obj) ?? fallback;
    const sumItens = (itens) => (itens || []).reduce((s, it) => s + Number(it?.valor || 0), 0);
    const hasCPP = (itens) => (itens || []).some(it => String(it?.tributo || '').toUpperCase().startsWith('CPP'));
    const aliqFmtOr = (blocoReg, base) => {
      const txt = blocoReg?.aliquota_fmt || blocoReg?.aliquota_efetiva_pct;
      if (txt != null && txt !== '') return String(txt).includes('%') ? String(txt) : pct(txt);
      const total = Number(blocoReg?.imposto ?? 0) || sumItens(blocoReg?.itens);
      return base > 0 ? pct((total / base) * 100) : '‚Äî';
    };
    const qs = (k) => new URLSearchParams(location.search).get(k);

    // ===== Carrega dados do localStorage
    let data = null;
    (function load(){
      try {
        const saved = localStorage.getItem('analiseTributaria');
        if (!saved) throw new Error('Sem dados');
        data = JSON.parse(saved);
      } catch(e){
        alert('Nenhuma an√°lise encontrada. Volte ao formul√°rio para gerar os dados.');
        location.href = '/form';
      }
    })();

    // ===== Estado (mensal/anual)
    const hasNew = data && data.calculos && (data.calculos.mensal || data.calculos.anual);
    let periodo = (hasNew ? (data.periodo_padrao || (data.calculos.anual ? 'anual':'mensal')) : 'legacy');

    // ===== Identifica√ß√£o padr√£o (empresa)
    document.getElementById('empresaNome').textContent = safeGet(data,'empresa.nome','-');
    document.getElementById('empresaCNPJ').textContent = safeGet(data,'empresa.cnpj','');
    document.getElementById('empresaMunicipio').textContent = safeGet(data,'empresa.municipio','-');
    document.getElementById('empresaTipo').textContent = 'Tipo: ' + (safeGet(data,'empresa.tipo','-'));
    const regAtual = safeGet(data,'empresa.regime_atual', null);
    if(regAtual) document.getElementById('regimeAtual').textContent = 'Regime atual: ' + regAtual;

    // ===== Toggle UI
    const btnMensal = document.getElementById('btnMensal');
    const btnAnual  = document.getElementById('btnAnual');
    function paintToggle(){
      btnMensal.classList.toggle('on', periodo==='mensal');
      btnAnual.classList.toggle('on',  periodo==='anual');
      const disabled = !hasNew;
      btnMensal.disabled = disabled; btnAnual.disabled = disabled;
      if(disabled){ btnMensal.title = btnAnual.title = 'Resposta antiga (sem mensal/anual)'; }
    }
    btnMensal.addEventListener('click', ()=>{ if(hasNew){ periodo='mensal'; render(); } });
    btnAnual .addEventListener('click', ()=>{ if(hasNew){ periodo='anual';  render(); } });

    // ===== Charts
    let barChart=null, pieChart=null;
    function setBarChart(vS, vP){
      const ctx = document.getElementById('chartBarras').getContext('2d');
      if(barChart){ barChart.destroy(); }
      barChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: ['Simples', 'Presumido'],
          datasets: [{ label: 'Impostos (R$)', data: [vS, vP], borderWidth: 1 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => brl(c.raw) } } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') } } }
        }
      });
    }
    function setPieChart(vS, vP){
      const ctx = document.getElementById('chartPizza').getContext('2d');
      if(pieChart){ pieChart.destroy(); }
      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Simples','Presumido'], datasets: [{ data:[vS,vP] }] },
        options: { plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: c => `${c.label}: ${brl(c.raw)}` } } } }
      });
    }

    function renderTable(tbodyId, itens){
      const tb = document.getElementById(tbodyId);
      tb.innerHTML = '';
      (itens||[]).forEach(it=>{
        const tr = document.createElement('tr');
        const aliq = it.aliquota_pct;
        const aliqFmt = (aliq==null || aliq==='NA') ? '‚Äî' :
                        (String(aliq).includes('%') ? String(aliq) : (String(aliq).replace('.',',')) + '%');
        tr.innerHTML = `
          <td>${it.tributo||'-'}</td>
          <td>${aliqFmt}</td>
          <td>${brl(it.valor)}</td>`;
        tb.appendChild(tr);
      });
    }

    // ===== Render principal (usa bloco atual)
    function render(){
      paintToggle();

      let bloco = null, base = 0, labelPeriodo='‚Äî', mesesInfo='';
      if (hasNew) {
        bloco = data.calculos[periodo];

        const baseFromBloco = bloco?.base_utilizada;
        const baseMensal = data?.bases?.mensal ?? null;
        const baseAnual  = data?.bases?.anual  ?? null;
        const legacyBase = data?.calculo?.base_utilizada ?? null;

        if (periodo === 'mensal') {
          base = (baseFromBloco ?? baseMensal ?? (legacyBase!=null ? legacyBase/12 : 0));
          labelPeriodo = 'Mensal';
          mesesInfo = `(${bloco?.periodo_meses || 1} meses)`;
          if (baseAnual && base && base > baseAnual) base = baseAnual/12;
        } else {
          base = (baseFromBloco ?? baseAnual ?? (legacyBase ?? 0));
          labelPeriodo = 'Anual';
          mesesInfo = `(${bloco?.periodo_meses || 12} meses)`;
        }
      } else {
        bloco = data.calculo;
        base  = data?.calculo?.base_utilizada ?? 0;
        labelPeriodo = 'Anual (compat)';
        mesesInfo = `(${data?.calculo?.periodo_meses || 12} meses)`;
      }

      // Qual CNAE est√° em exibi√ß√£o neste momento?
      const cnaeExib = safeGet(data, 'cnaes.principal.codigo', safeGet(data,'empresa.cnae_atual', safeGet(data,'empresa.cnae_form','-')));
      document.getElementById('empresaCNAE').textContent = cnaeExib || '-';

      // Flags
      const imp = safeGet(data,'empresa.cnae_impeditivo_simples', null);
      document.getElementById('flagsCNAE').textContent = (imp===true ? 'CNAE impeditivo ao Simples' : imp===false ? 'CNAE permitido no Simples' : '');

      // Chip Anexo
      const anexoAtual = bloco?.anexo || data?.calculo?.anexo || '‚Äî';
      document.getElementById('chipAnexo').textContent = anexoAtual || '‚Äî';

      // KPIs
      const totalS = Number(bloco?.simples?.imposto ?? 0) || sumItens(bloco?.simples?.itens);
      const totalP = Number(bloco?.presumido?.imposto ?? 0) || sumItens(bloco?.presumido?.itens);
      const aliqS = aliqFmtOr(bloco?.simples, base);
      const aliqP = aliqFmtOr(bloco?.presumido, base);

      document.getElementById('kpiPeriodo').textContent = labelPeriodo;
      document.getElementById('kpiMeses').textContent   = mesesInfo;
      document.getElementById('kpiBase').textContent    = brl(base);
      document.getElementById('kpiAliqS').textContent   = aliqS;
      document.getElementById('kpiAliqP').textContent   = aliqP;
      document.getElementById('kpiMelhor').textContent  = bloco?.melhor_regime || '‚Äî';
      document.getElementById('kpiEconomia').textContent= 'Economia estimada: ' + (bloco?.economia_fmt || '‚Äî');

      // Gr√°ficos
      setBarChart(totalS, totalP);
      setPieChart(totalS, totalP);

      // Tabelas detalhadas
      renderTable('tbodySimples',   bloco?.simples?.itens || []);
      renderTable('tbodyPresumido', bloco?.presumido?.itens || []);

      // Rodap√©s + nota sobre CPP
      const notaCPP_S = hasCPP(bloco?.simples?.itens) ? ' ‚Ä¢ inclui CPP' + (anexoAtual==='IV' ? ' (Anexo IV)' : '') : '';
      const notaCPP_P = hasCPP(bloco?.presumido?.itens) ? ' ‚Ä¢ inclui CPP' : '';
      document.getElementById('sumS').textContent = `Total: ${brl(totalS)} ‚Ä¢ Al√≠quota: ${aliqS}${notaCPP_S}`;
      document.getElementById('sumP').textContent = `Total: ${brl(totalP)} ‚Ä¢ Al√≠quota: ${aliqP}${notaCPP_P}`;

      // Tabela: CNAEs (principal + secund√°rios)
      const tbCnaes = document.getElementById('tbodyCnaes');
      tbCnaes.innerHTML = '';
      const principal = safeGet(data,'cnaes.principal', null);
      const secundarios = safeGet(data,'cnaes.secundarios', []) || [];

      function rowCnae(item, isPrincipal=false){
        const tr = document.createElement('tr');
        const badge = isPrincipal ? `<span class="chip" title="CNAE principal">Principal</span>` : '';
        tr.innerHTML = `
          <td><div class="flex items-center gap-2"><span>${item.codigo || '-'}</span>${badge}</div></td>
          <td>${item.descricao || '-'}</td>
          <td>${item.anexo || '‚Äî'}</td>
          <td>${brl(item.simples_anual || 0)}</td>
          <td>${brl(item.presumido_anual || 0)}</td>
          <td><button class="btn-slim open-cnae" data-cnae="${item.codigo}" data-url="${item.detalhe_url || ''}">Abrir CNAE</button></td>
        `;
        tbCnaes.appendChild(tr);
      }

      if (principal) rowCnae(principal, true);
      secundarios.forEach(s => rowCnae(s, false));

      // Tabela: Atividades do formul√°rio (se houver)
      const tbAtv = document.getElementById('tbodyAtividades');
      const itens = safeGet(data,'atividades.itens',[]) || [];
      tbAtv.innerHTML = '';
      itens.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.nome||'-'}</td>
          <td>${brl(it.receita_12m||0)}</td>
          <td>${brl(it.estimativa_proximo_ano||0)}</td>
          <td>${it.exportacao ? 'Sim':'N√£o'}</td>`;
        tbAtv.appendChild(tr);
      });
      const tot = safeGet(data,'atividades.totais_exportacao',null);
      if(tot){
        document.getElementById('totaisExport').innerHTML =
          `Exporta√ß√£o (totais): 12m <b>${tot.receita_12m_fmt || brl(tot.receita_12m||0)}</b> ‚Ä¢ Pr√≥x. ano <b>${tot.estimativa_prox_ano_fmt || brl(tot.estimativa_prox_ano||0)}</b>`;
      }

      // Liga os bot√µes Abrir CNAE
      document.querySelectorAll('.open-cnae').forEach(btn=>{
        btn.addEventListener('click', ()=> abrirCNAE(btn.dataset.cnae, btn.dataset.url));
      });
    }

    // ===== Abrir CNAE (gera dashboard completo do CNAE escolhido)
    async function abrirCNAE(cnaeCodigo, fallbackUrl){
      const payloadRaw = localStorage.getItem('payloadAnalise');
      if (!payloadRaw) {
        // Sem payload salvo: abre a URL de detalhe (pelo menos navega)
        if (fallbackUrl) location.href = fallbackUrl;
        else alert('Para abrir o dashboard completo do CNAE, volte ao formul√°rio e gere novamente (o payload ainda n√£o foi salvo).');
        return;
      }
      try{
        const payload = JSON.parse(payloadRaw);
        payload.cnae = cnaeCodigo;                // troca s√≥ o CNAE
        // mant√©m outros_cnaes como estava (n√£o impacta)
        const apiUrlBase = (window.apiUrlBaseOverride || "http://127.0.0.1:8000");
        const resp = await fetch(`${apiUrlBase}/analise`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if(!resp.ok){
          const text = await resp.text();
          alert(`Erro ao recalcular para o CNAE ${cnaeCodigo}: ${text}`);
          return;
        }
        const json = await resp.json();
        // atualiza storage e re-renderiza em mem√≥ria
        localStorage.setItem('analiseTributaria', JSON.stringify(json));
        // opcional: marca o CNAE na URL (pra compartilhar o link)
        const u = new URL(location.href); u.searchParams.set('cnae', cnaeCodigo); history.replaceState({}, '', u.toString());
        // re-render
        data = json;
        periodo = (data.periodo_padrao || (data?.calculos?.anual ? 'anual':'mensal'));
        render();
        // feedback sutil
        toast(`Dashboard atualizado para o CNAE ${cnaeCodigo}`);
      }catch(e){
        alert(`Erro de rede ao abrir CNAE: ${e.message}`);
      }
    }

    // ===== Toast simples
    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position='fixed'; el.style.bottom='20px'; el.style.right='20px';
      el.style.background='#1d4ed8'; el.style.color='#fff'; el.style.padding='10px 14px';
      el.style.borderRadius='10px'; el.style.boxShadow='0 6px 20px rgba(0,0,0,.12)'; el.style.zIndex=9999;
      document.body.appendChild(el); setTimeout(()=> el.remove(), 2200);
    }

    // ===== A√ß√µes gerais
    document.getElementById('btnVoltar').addEventListener('click', ()=>{ location.href = '/form'; });
    document.getElementById('btnLimpar').addEventListener('click', ()=>{
      localStorage.removeItem('analiseTributaria');
      localStorage.removeItem('payloadAnalise');
      alert('Dados limpos. Voltando ao formul√°rio.');
      location.href = '/form';
    });
    document.getElementById('btnCSV').addEventListener('click', ()=>{
      const itens = (data?.atividades?.itens)||[];
      const rows = [['Atividade','Receita 12m','Estimativa Pr√≥x. Ano','Exporta√ß√£o']];
      itens.forEach(it=> rows.push([ it.nome||'', (it.receita_12m||0), (it.estimativa_proximo_ano||0), it.exportacao?'Sim':'N√£o' ]));
      const csv = rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'atividades.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    // ===== Render inicial
    render();

    // ===== Se veio com ?cnae= na URL, tenta abrir automaticamente (se houver payload salvo)
    (async function autoOpenCNAE(){
      const param = qs('cnae');
      if (!param) return;
      const payloadRaw = localStorage.getItem('payloadAnalise');
      if (!payloadRaw) return; // sem payload n√£o d√° pra recalcular; mant√©m a tela atual
      await abrirCNAE(param, null);
    })();
  </script>
</body>
</html>
