<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tribut√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Tema claro */
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f5f7fb; color:#111827; }
    .card { background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .muted { color:#6b7280; }
    .title { color:#1f2937; }
    table { width:100%; border-collapse: collapse; }
    th,td{ padding:10px; border-bottom:1px solid #eef2f7 }
    th{ color:#374151; font-weight:600; text-align:left; background:#f3f4f6 }
    .kpi { font-size:1.75rem; font-weight:800; color:#111827 }
    .chip { font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem; border:1px solid #e5e7eb; background:#f9fafb; color:#374151 }
    a.link { color:#2563eb; text-decoration: underline; }
    .ok   { color:#059669 }
    .warn { color:#d97706 }
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold title">üìä Dashboard Tribut√°rio</h1>
    <p class="muted text-sm">Visualiza√ß√£o interativa do comparativo Simples x Presumido</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 space-y-6">

    <!-- Identifica√ß√£o -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card">
        <div class="muted text-xs">Empresa</div>
        <div id="empresaNome" class="text-lg font-semibold"></div>
        <div id="empresaCNPJ" class="muted text-xs"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Munic√≠pio</div>
        <div id="empresaMunicipio" class="text-lg font-semibold"></div>
        <div class="muted text-xs">
          <span id="empresaTipo" class="chip"></span>
          <span id="regimeAtual" class="chip ml-2"></span>
        </div>
      </div>
      <div class="card">
        <div class="muted text-xs">CNAE</div>
        <div id="empresaCNAE" class="text-lg font-semibold"></div>
        <div id="flagsCNAE" class="muted text-xs"></div>
      </div>
    </section>

    <!-- S√≥cio em outra empresa -->
    <section id="outraEmpresaSec" class="grid grid-cols-1 md:grid-cols-3 gap-4" style="display:none;">
      <div class="card md:col-span-3">
        <div class="muted text-xs">Participa√ß√£o em outra empresa</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-1">
          <div>
            <div class="muted text-xs">√â s√≥cio?</div>
            <div id="ehSocio" class="text-lg font-semibold"></div>
          </div>
          <div>
            <div class="muted text-xs">Percentual de participa√ß√£o</div>
            <div id="pctSocio" class="text-lg font-semibold"></div>
          </div>
          <div>
            <div class="muted text-xs">Faturamento anual da outra</div>
            <div id="fatOutra" class="text-lg font-semibold"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div class="card">
        <div class="muted text-xs">Base de c√°lculo (RBT12)</div>
        <div id="kpiBase" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">M√©dia mensal (derivada)</div>
        <div id="kpiMediaMensal" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Simples</div>
        <div id="kpiAliqS" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Al√≠quota efetiva ‚Äî Presumido</div>
        <div id="kpiAliqP" class="kpi"></div>
      </div>
      <div class="card">
        <div class="muted text-xs">Regime mais vantajoso</div>
        <div id="kpiMelhor" class="kpi"></div>
        <div id="kpiEconomia" class="muted text-xs"></div>
        <div id="kpiFatorR" class="muted text-xs mt-1"></div>
      </div>
    </section>

    <!-- Impostos calculados (abas) -->
    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <div class="muted text-sm">Impostos calculados por regime</div>
        <div class="flex gap-2">
          <button id="tabSimples"   data-tab="simples"
                  class="px-3 py-1 rounded-md border border-gray-200 bg-white text-gray-800 hover:bg-gray-50">
            Simples Nacional
          </button>
          <button id="tabPresumido" data-tab="presumido"
                  class="px-3 py-1 rounded-md border border-gray-200 bg-white text-gray-800 hover:bg-gray-50">
            Lucro Presumido
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Tributo</th>
              <th>Al√≠quota (%)</th>
              <th>Valor (R$)</th>
              <th>Obs.</th>
            </tr>
          </thead>
          <tbody id="tbodyImpostos"></tbody>
          <tfoot>
            <tr>
              <td class="font-semibold">Total</td>
              <td></td>
              <td id="totalImpostos" class="font-semibold"></td>
              <td></td>
            </tr>
            <tr>
              <td class="font-semibold">Al√≠quota efetiva</td>
              <td id="aliqEfetiva" class="font-semibold"></td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Gr√°ficos -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="muted text-sm mb-2">Comparativo de impostos</div>
        <canvas id="chartBarras" height="280"></canvas>
      </div>
      <div class="card">
        <div class="muted text-sm mb-2">Participa√ß√£o relativa</div>
        <canvas id="chartPizza" height="280"></canvas>
      </div>
    </section>

    <!-- Tabela atividades -->
    <section class="card">
      <div class="muted text-sm mb-3">Separa√ß√£o por atividade</div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Atividade</th>
              <th>Receita 12m</th>
              <th>Estimativa Pr√≥x. Ano</th>
              <th>Exporta√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tbodyAtividades"></tbody>
          <tfoot>
            <tr><td colspan="4" id="totaisExport" class="pt-2 muted"></td></tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- A√ß√µes -->
    <section class="flex flex-col md:flex-row gap-3 pb-10">
      <button id="btnVoltar" class="px-4 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50">‚Üê Voltar ao formul√°rio</button>
      <button id="btnLimpar" class="px-4 py-2 rounded-lg bg-red-50 text-red-700 border border-red-200 hover:bg-red-100">Limpar dados salvos</button>
      <button id="btnCSV" class="px-4 py-2 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100">Exportar atividades (CSV)</button>
    </section>
  </main>

  <script>
    const isGithubPages = location.hostname.endsWith('github.io');
    const formURL = isGithubPages ? 'index.html' : '/form';
    const brl = n => 'R$ ' + Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const pct = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2}) + '%';
    function safeGet(obj, path, fallback=null){
      return path.split('.').reduce((acc,k)=> (acc && acc[k]!=null) ? acc[k] : null, obj) ?? fallback;
    }

    // ===== Carregar an√°lise
    let data = null;
    try {
      const saved = localStorage.getItem('analiseTributaria');
      if (!saved) {
        alert('Nenhuma an√°lise encontrada. Volte ao formul√°rio para gerar os dados.');
        location.href = formURL;
      } else {
        data = JSON.parse(saved);
      }
    } catch (e) {
      console.error(e);
      alert('N√£o foi poss√≠vel ler os dados salvos. Voltando ao formul√°rio.');
      location.href = formURL;
    }
    if(!data) data = {};

    // ===== Cabe√ßalhos
    document.getElementById('empresaNome').textContent = safeGet(data,'empresa.nome','-');
    document.getElementById('empresaCNPJ').textContent = safeGet(data,'empresa.cnpj','');
    document.getElementById('empresaMunicipio').textContent = safeGet(data,'empresa.municipio','-');
    document.getElementById('empresaTipo').textContent = 'Tipo: ' + (safeGet(data,'empresa.tipo','-'));
    document.getElementById('empresaCNAE').textContent = safeGet(data,'empresa.cnae_atual', safeGet(data,'empresa.cnae_form','-'));
    const regAtual = safeGet(data,'empresa.regime_atual', null);
    if(regAtual) document.getElementById('regimeAtual').textContent = 'Regime atual: ' + regAtual;
    const imp = safeGet(data,'empresa.cnae_impeditivo_simples', null);
    document.getElementById('flagsCNAE').textContent = (imp===true ? 'CNAE impeditivo ao Simples' : imp===false ? 'CNAE permitido no Simples' : '');

    // ===== Outra empresa (se existir)
    const outra = safeGet(data, 'empresa.outra_empresa', null);
    if (outra && typeof outra === 'object') {
      document.getElementById('outraEmpresaSec').style.display = 'grid';
      document.getElementById('ehSocio').textContent = outra.eh_socio ? 'Sim' : 'N√£o';
      document.getElementById('pctSocio').textContent = outra.percentual_participacao != null ? pct(outra.percentual_participacao) : '‚Äî';
      document.getElementById('fatOutra').textContent = outra.faturamento_anual != null ? brl(outra.faturamento_anual) : '‚Äî';
    }

    /* ===== KPIs ===== */
    const base = Number(safeGet(data,'calculo.base_utilizada',0)) || 0;
    const mediaMensal = base / 12.0;

    // totais absolutos (reuso nos gr√°ficos e nas abas)
    const vS = Number(safeGet(data,'calculo.simples.imposto',0)) || 0;
    const vP = Number(safeGet(data,'calculo.presumido.imposto',0)) || 0;

    // al√≠quotas vindas do back
    const aS_num = Number(safeGet(data,'calculo.simples.aliquota_num', NaN));
    const aP_num = Number(safeGet(data,'calculo.presumido.aliquota_num', NaN));
    const aS_fmt_back = safeGet(data,'calculo.simples.aliquota_fmt', null);
    const aP_fmt_back = safeGet(data,'calculo.presumido.aliquota_fmt', null);

    const pctBR = n => n.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) + '%';

    // 1) usa *_num (fra√ß√£o), 2) sen√£o imposto/base, 3) fallback fmt
    function effAliqSmart(imposto, base, numFromBack, fmtBack){
      if (Number.isFinite(numFromBack)) return pctBR(numFromBack*100);
      if (base > 0 && Number.isFinite(imposto)) {
        const x = (imposto / base) * 100;
        if (Number.isFinite(x)) return pctBR(x);
      }
      return (typeof fmtBack === 'string' && fmtBack.trim()) ? fmtBack : '‚Äî';
    }

    document.getElementById('kpiBase').textContent       = brl(base);
    document.getElementById('kpiMediaMensal').textContent= brl(mediaMensal);
    document.getElementById('kpiAliqS').textContent      = effAliqSmart(vS, base, aS_num, aS_fmt_back);
    document.getElementById('kpiAliqP').textContent      = effAliqSmart(vP, base, aP_num, aP_fmt_back);
    document.getElementById('kpiMelhor').textContent     = safeGet(data,'calculo.melhor_regime','‚Äî');
    document.getElementById('kpiEconomia').textContent   = 'Economia estimada: ' + safeGet(data,'calculo.economia_fmt','‚Äî');

    // Fator R (se vier)
    const fatorRFlag = safeGet(data, 'calculo.inputs_normalizados.fator_r_efetivo', null);
    if (fatorRFlag !== null) {
      document.getElementById('kpiFatorR').innerHTML = fatorRFlag
        ? '<span class="ok">Fator R ‚â• 28% (encaixa em Anexo III)</span>'
        : '<span class="warn">Fator R &lt; 28% (encaixa em Anexo V)</span>';
    }

    // ===== Abas: Impostos calculados =====
    const tabSimples   = document.getElementById('tabSimples');
    const tabPresumido = document.getElementById('tabPresumido');
    const tbodyImpostos = document.getElementById('tbodyImpostos');
    const totalImpostos = document.getElementById('totalImpostos');
    const aliqEfetiva  = document.getElementById('aliqEfetiva');

    function setActiveTab(btn) {
      [tabSimples, tabPresumido].forEach(b=>{
        b.classList.remove('bg-indigo-600','text-white','border-indigo-600');
        b.classList.add('bg-white','text-gray-800','border-gray-200');
      });
      btn.classList.remove('bg-white','text-gray-800','border-gray-200');
      btn.classList.add('bg-indigo-600','text-white','border-indigo-600');
    }

    function pctSmart(regime) {
      if (regime === 'simples') {
        if (Number.isFinite(aS_num)) return pctBR(aS_num*100);
        if (base>0) return pctBR((vS/base)*100);
        return aS_fmt_back || '‚Äî';
      } else {
        if (Number.isFinite(aP_num)) return pctBR(aP_num*100);
        if (base>0) return pctBR((vP/base)*100);
        return aP_fmt_back || '‚Äî';
      }
    }

    function renderImpostos(regime='simples'){
      setActiveTab(regime==='simples' ? tabSimples : tabPresumido);

      const itens = safeGet(data, `calculo.${regime}.itens`, []) || [];
      tbodyImpostos.innerHTML = '';
      let total = 0;

      itens.forEach(it=>{
        const tr = document.createElement('tr');
        const aliq = (it.aliquota_pct ?? '').toString(); // "xx,xx" ou "xx.xx"
        const val  = Number(it.valor || 0);
        total += val;
        tr.innerHTML = `
          <td>${it.tributo || '-'}</td>
          <td>${aliq ? aliq.replace('.', ',') + '%' : '‚Äî'}</td>
          <td>${brl(val)}</td>
          <td>${it.obs || ''}</td>
        `;
        tbodyImpostos.appendChild(tr);
      });

      totalImpostos.textContent = brl(total);
      aliqEfetiva.textContent = pctSmart(regime);
    }

    tabSimples.addEventListener('click', ()=>renderImpostos('simples'));
    tabPresumido.addEventListener('click', ()=>renderImpostos('presumido'));
    // inicial: Simples
    renderImpostos('simples');

    // ===== Gr√°ficos
    const ctxBar = document.getElementById('chartBarras').getContext('2d');
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: ['Simples', 'Presumido'],
        datasets: [{
          label: 'Impostos (R$)',
          data: [vS, vP],
          backgroundColor: ['#60a5fa','#f87171'],
          borderColor: ['#3b82f6','#ef4444'],
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => brl(c.raw) } } },
        scales: { y: { beginAtZero: true, ticks: { callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') } } }
      }
    });

    const ctxPie = document.getElementById('chartPizza').getContext('2d');
    new Chart(ctxPie, {
      type: 'doughnut',
      data: {
        labels: ['Simples','Presumido'],
        datasets: [{ data:[vS,vP], backgroundColor:['#60a5fa','#f87171'] }]
      },
      options: { plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: c => `${c.label}: ${brl(c.raw)}` } } } }
    });

    // ===== Tabela de atividades
    const tb = document.getElementById('tbodyAtividades');
    const itens = safeGet(data,'atividades.itens',[]) || [];
    tb.innerHTML = '';
    itens.forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.nome||'-'}</td>
        <td>${brl(it.receita_12m||0)}</td>
        <td>${brl(it.estimativa_proximo_ano||0)}</td>
        <td>${it.exportacao ? 'Sim':'N√£o'}</td>`;
      tb.appendChild(tr);
    });
    const tot = safeGet(data,'atividades.totais_exportacao',null);
    if(tot){
      document.getElementById('totaisExport').innerHTML =
        `Exporta√ß√£o (totais): 12m <b>${tot.receita_12m_fmt || brl(tot.receita_12m||0)}</b> ‚Ä¢ Pr√≥x. ano <b>${tot.estimativa_prox_ano_fmt || brl(tot.estimativa_prox_ano||0)}</b>`;
    }

    // ===== A√ß√µes
    document.getElementById('btnVoltar').addEventListener('click', ()=>{ location.href = formURL; });
    document.getElementById('btnLimpar').addEventListener('click', ()=>{
      localStorage.removeItem('analiseTributaria');
      alert('Dados limpos. Voltando ao formul√°rio.');
      location.href = formURL;
    });
    document.getElementById('btnCSV').addEventListener('click', ()=>{
      const rows = [['Atividade','Receita 12m','Estimativa Pr√≥x. Ano','Exporta√ß√£o']];
      itens.forEach(it=> rows.push([ it.nome||'', (it.receita_12m||0), (it.estimativa_proximo_ano||0), it.exportacao?'Sim':'N√£o' ]));
      const csv = rows.map(r=> r.map(v=> {
        const s = String(v).replace(/"/g,'""'); return `"${s}"`;
      }).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'atividades.csv'; a.click(); URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
