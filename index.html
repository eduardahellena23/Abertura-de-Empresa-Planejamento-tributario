<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador de Planejamento Tribut√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #1a202c; }
    .page { display: none; }
    .page-container { z-index: 10; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <div class="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full page-container">
    <!-- Logo -->
    <div class="mb-6 flex justify-center">
      <img src="Logotipo_primario_medio.jpg" alt="Logo do Escrit√≥rio" class="h-12 w-auto">
    </div>

    <!-- Splash -->
    <div id="splashPage" class="page flex flex-col items-center justify-center text-center">
      <h1 class="text-3xl font-bold mb-6 text-indigo-600">O que voc√™ deseja simular?</h1>
      <div class="space-y-4">
        <button id="btnEmpresa" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
          Planejamento para Empresa
        </button>
        <button id="btnPessoaFisica" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
          C√°lculo para Pessoa F√≠sica
        </button>
      </div>
    </div>

    <!-- Empresa -->
    <div id="empresaFormPage" class="page">
      <h1 class="text-3xl font-bold mb-6 text-center text-indigo-600">Simulador de Planejamento Tribut√°rio</h1>

      <form id="tributarioForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Nome + CNPJ -->
        <div class="flex flex-col md:col-span-2">
          <label for="nome_empresa" class="text-sm font-medium text-gray-700">Nome da Empresa</label>
          <input type="text" id="nome_empresa" name="nome_empresa" required
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex flex-col md:col-span-2">
          <label for="cnpj" class="text-sm font-medium text-gray-700">CNPJ (Opcional)</label>
          <input type="text" id="cnpj" name="cnpj"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <!-- Abertura x Constitu√≠da -->
        <div class="flex flex-col">
          <label for="tipo_empresa" class="text-sm font-medium text-gray-700">Abertura ou Constitu√≠da?</label>
          <select id="tipo_empresa" name="tipo_empresa" required
                  class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            <option value="abertura">Abertura</option>
            <option value="constituida">Constitu√≠da</option>
          </select>
        </div>

        <!-- Faturamento & Munic√≠pio -->
        <div class="flex flex-col">
          <label for="faturamento" class="text-sm font-medium text-gray-700">Faturamento Anual (R$)</label>
          <input type="number" id="faturamento" name="faturamento" required step="0.01"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex flex-col">
          <label for="municipio" class="text-sm font-medium text-gray-700">Munic√≠pio</label>
          <input type="text" id="municipio" name="municipio" required
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <!-- S√≥cio outra empresa + % -->
        <div class="flex flex-col">
          <label for="socio_outra_empresa" class="text-sm font-medium text-gray-700">S√≥cio de outra empresa?</label>
          <select id="socio_outra_empresa" name="socio_outra_empresa" required
                  class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            <option value="nao">N√£o</option>
            <option value="sim">Sim</option>
          </select>
        </div>
        <div class="flex flex-col" id="wrap_percentual" style="display:none;">
          <label for="socio_outra_empresa_percentual" class="text-sm font-medium text-gray-700">% do s√≥cio na outra empresa</label>
          <input type="number" id="socio_outra_empresa_percentual" step="0.01" placeholder="0"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <!-- CNAE & Pr√≥-labore -->
        <div class="flex flex-col">
          <label for="cnae" class="text-sm font-medium text-gray-700">CNAE (formul√°rio)</label>
          <input type="text" id="cnae" name="cnae" required
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex flex-col">
          <label for="prolabore" class="text-sm font-medium text-gray-700">Pr√≥-labore (R$)</label>
          <input type="number" id="prolabore" name="prolabore" required step="0.01"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <!-- Anexo (bot√µes) -->
        <div class="flex flex-col md:col-span-2">
          <label class="text-sm font-medium text-gray-700 mb-2">Anexo Simples Nacional</label>
          <div id="anexo-buttons" class="grid grid-cols-2 md:grid-cols-3 gap-2">
            <button type="button" data-anexo="I"   class="anexo-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Anexo I</button>
            <button type="button" data-anexo="II"  class="anexo-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Anexo II</button>
            <button type="button" data-anexo="III" class="anexo-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Anexo III</button>
            <button type="button" data-anexo="IV"  class="anexo-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Anexo IV</button>
            <button type="button" data-anexo="V"   class="anexo-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Anexo V</button>
            <button type="button" data-anexo="VI"  class="anexo-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Anexo VI</button>
          </div>
          <input type="hidden" id="anexo" name="anexo" required>
        </div>

        <!-- Comparar (bot√µes) -->
        <div class="flex flex-col md:col-span-2">
          <label class="text-sm font-medium text-gray-700 mb-2">Regime a Comparar</label>
          <div id="comparar-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <button type="button" data-comparar="Simples Nacional" class="comparar-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Simples Nacional</button>
            <button type="button" data-comparar="Lucro Presumido"  class="comparar-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Lucro Presumido</button>
            <button type="button" data-comparar="Ambos"            class="comparar-btn py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Ambos</button>
          </div>
          <input type="hidden" id="comparar" name="comparar" required>
        </div>

        <!-- Pr√≥-labore ideal & ICMS -->
        <div class="flex flex-col">
          <label for="prolabore_ideal" class="text-sm font-medium text-gray-700">Pr√≥-labore Ideal (R$)</label>
          <input type="number" id="prolabore_ideal" name="prolabore_ideal" required step="0.01"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex flex-col">
          <label for="icms" class="text-sm font-medium text-gray-700">ICMS (%)</label>
          <input type="number" id="icms" name="icms" required step="0.01"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <!-- Funcion√°rios (formul√°rio padr√£o) -->
        <div class="flex flex-col">
          <label for="tem_funcionarios" class="text-sm font-medium text-gray-700">Possui Funcion√°rios?</label>
          <select id="tem_funcionarios" name="tem_funcionarios" required
                  class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            <option value="nao">N√£o</option>
            <option value="sim">Sim</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label for="folha" class="text-sm font-medium text-gray-700">Valor da Folha (R$)</label>
          <input type="number" id="folha" name="folha" required step="0.01"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <!-- ================= Empresa Constitu√≠da (condicional) ================= -->
        <div id="constitFields" class="md:col-span-2 p-4 rounded-lg border border-indigo-200 bg-indigo-50" style="display:none;">
          <h3 class="text-lg font-semibold text-indigo-700 mb-3">üè¢ Empresa j√° constitu√≠da</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700">Regime atual</label>
              <select id="regime_atual" class="mt-1 p-3 border border-gray-300 rounded-md">
                <option value="">Selecione...</option>
                <option value="Simples">Simples</option>
                <option value="Presumido">Presumido</option>
                <option value="MEI">MEI</option>
              </select>
            </div>

            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700">CNAE atual</label>
              <input id="cnae_atual" type="text" placeholder="62.02-3-00"
                     class="mt-1 p-3 border border-gray-300 rounded-md">
            </div>

            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700">CNAE impeditivo ao Simples?</label>
              <select id="cnae_impeditivo_simples" class="mt-1 p-3 border border-gray-300 rounded-md">
                <option value="">N√£o informado</option>
                <option value="true">Sim</option>
                <option value="false">N√£o</option>
              </select>
            </div>

            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700">Impostos em aberto?</label>
              <select id="impostos_em_aberto" class="mt-1 p-3 border border-gray-300 rounded-md">
                <option value="">N√£o informado</option>
                <option value="true">Sim</option>
                <option value="false">N√£o</option>
              </select>
            </div>

            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700">M√©dia do faturamento (√∫ltimos 12m)</label>
              <input id="media_faturamento_12m" type="text" placeholder="R$ 0,00"
                     class="mt-1 p-3 border border-gray-300 rounded-md">
              <span class="text-xs text-gray-500 mt-1">Aceita 600000, 600.000,00 etc.</span>
            </div>

            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700">Estimativa faturamento (pr√≥ximo ano)</label>
              <input id="estimativa_faturamento_proximo_ano" type="text" placeholder="R$ 0,00"
                     class="mt-1 p-3 border border-gray-300 rounded-md">
            </div>

            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700">Possui funcion√°rios?</label>
              <select id="possui_funcionarios" class="mt-1 p-3 border border-gray-300 rounded-md">
                <option value="">N√£o informado</option>
                <option value="true">Sim</option>
                <option value="false">N√£o</option>
              </select>
            </div>

            <div class="flex flex-col" id="wrap_folha12" style="display:none;">
              <label class="text-sm font-medium text-gray-700">Folha (√∫ltimos 12m) ‚Äì total</label>
              <input id="folha_12m_total" type="text" placeholder="R$ 0,00"
                     class="mt-1 p-3 border border-gray-300 rounded-md">
            </div>
          </div>

          <!-- Separa√ß√£o por atividade -->
          <div class="mt-4">
            <div class="flex items-center justify-between">
              <h4 class="font-semibold text-gray-700">üìä Separa√ß√£o por atividade</h4>
              <button type="button" id="btnAddAtividade" class="px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-100">+ Adicionar</button>
            </div>

            <div class="mt-2 overflow-x-auto">
              <table class="min-w-full text-sm" id="tblAtividades">
                <thead>
                <tr class="text-left text-gray-600">
                  <th class="py-2 pr-2">Atividade</th>
                  <th class="py-2 pr-2">Receita 12m (R$)</th>
                  <th class="py-2 pr-2">Estimativa Pr√≥x. Ano (R$)</th>
                  <th class="py-2 pr-2">Exporta√ß√£o?</th>
                  <th class="py-2 pr-2"></th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- ================= /Empresa Constitu√≠da ================= -->

        <div class="md:col-span-2 mt-2 text-center">
          <div class="flex flex-col md:flex-row items-center justify-center gap-3">
            <button type="submit" id="btnDashboard"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300">
              Ver Dashboard
            </button>
            <button type="button" id="btnExcel"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300">
              Baixar Planilha (Excel)
            </button>
            <button type="button" id="backToSplash1"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300">
              Voltar
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Pessoa F√≠sica (mantido) -->
    <div id="pessoaFisicaFormPage" class="page">
      <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">C√°lculo de Imposto de Renda</h1>
      <form id="irpfForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2 flex flex-col">
          <label for="renda_mensal" class="text-sm font-medium text-gray-700">Renda Mensal (R$)</label>
          <input type="number" id="renda_mensal" name="renda_mensal" required step="0.01"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500">
        </div>
        <div class="md:col-span-2 flex flex-col">
          <label for="despesas_dedutiveis" class="text-sm font-medium text-gray-700">Total de Despesas Dedut√≠veis (R$)</label>
          <input type="number" id="despesas_dedutiveis" name="despesas_dedutiveis" required step="0.01"
                 class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500">
        </div>
        <div class="md:col-span-2 mt-4 text-center">
          <button type="submit" id="submitPfButton"
                  class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg 
                         shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
            Gerar e Baixar Relat√≥rio
          </button>
          <button type="button" id="backToSplash2" class="ml-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
            Voltar
          </button>
        </div>
      </form>
    </div>

    <!-- Status -->
    <div class="mt-8 p-4 bg-gray-100 rounded-lg text-left">
      <h2 class="text-xl font-semibold mb-2">Status do Processo:</h2>
      <p id="statusMessage" class="text-gray-600">Selecione uma op√ß√£o para come√ßar.</p>
    </div>
  </div>

  <script>
    // ===== Navega√ß√£o
    const splashPage = document.getElementById('splashPage');
    const empresaFormPage = document.getElementById('empresaFormPage');
    const pessoaFisicaFormPage = document.getElementById('pessoaFisicaFormPage');
    const btnEmpresa = document.getElementById('btnEmpresa');
    const btnPessoaFisica = document.getElementById('btnPessoaFisica');
    const backToSplash1 = document.getElementById('backToSplash1');
    const backToSplash2 = document.getElementById('backToSplash2');
    const statusMessage = document.getElementById('statusMessage');
    function showPage(id){
      document.querySelectorAll('.page').forEach(p => p.style.display = (p.id===id?'flex':'none'));
      statusMessage.textContent = 'Preencha o formul√°rio e clique no bot√£o.';
    }
    btnEmpresa?.addEventListener('click', ()=>showPage('empresaFormPage'));
    btnPessoaFisica?.addEventListener('click', ()=>showPage('pessoaFisicaFormPage'));
    backToSplash1?.addEventListener('click', ()=>showPage('splashPage'));
    backToSplash2?.addEventListener('click', ()=>showPage('splashPage'));
    window.onload = ()=>showPage('splashPage');

    // ===== API
    const apiUrlBase = 'http://127.0.0.1:8000';

    // ===== Helpers
    function parseNumBR(v){
      if(v==null) return null;
      const s = String(v).trim();
      if(!s) return null;
      const norm = s.replace(/[R$\s]/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',','.');
      const n = Number(norm);
      return isNaN(n)? null : n;
    }

    // ===== Constitu√≠da: visibilidade
    const tipoEmpresa = document.getElementById('tipo_empresa');
    const constitFields = document.getElementById('constitFields');
    function toggleConstituidaUI(){
      const isConstituida = tipoEmpresa.value === 'constituida';
      constitFields.style.display = isConstituida ? 'block' : 'none';
    }
    tipoEmpresa.addEventListener('change', toggleConstituidaUI);
    toggleConstituidaUI();

    // S√≥cio outra empresa -> % vis√≠vel
    const socioOutra = document.getElementById('socio_outra_empresa');
    const wrapPercentual = document.getElementById('wrap_percentual');
    function togglePercentual(){ wrapPercentual.style.display = (socioOutra.value === 'sim') ? 'block' : 'none'; }
    socioOutra.addEventListener('change', togglePercentual);
    togglePercentual();

    // Possui funcion√°rios (constit) -> folha 12m vis√≠vel
    const possuiFunc = document.getElementById('possui_funcionarios');
    const wrapFolha12 = document.getElementById('wrap_folha12');
    if (possuiFunc){
      function toggleFolha12(){ wrapFolha12.style.display = (possuiFunc.value === 'true') ? 'block' : 'none'; }
      possuiFunc.addEventListener('change', toggleFolha12); toggleFolha12();
    }

    // ===== Bot√µes ‚ÄúAnexo‚Äù
    const anexoButtons = document.querySelectorAll('.anexo-btn');
    const anexoInput = document.getElementById('anexo');
    function setAnexoActive(btn) {
      anexoButtons.forEach(b => {
        b.classList.remove('bg-indigo-500','text-white','hover:bg-indigo-600','border-indigo-600');
        b.classList.add('bg-white','text-gray-700','hover:bg-gray-200','border','border-gray-300');
      });
      btn.classList.add('bg-indigo-500','text-white','hover:bg-indigo-600','border-indigo-600');
      btn.classList.remove('bg-white','text-gray-700','hover:bg-gray-200','border-gray-300');
    }
    anexoButtons.forEach(button => {
      button.addEventListener('click', (e) => { e.preventDefault(); setAnexoActive(button); anexoInput.value = button.dataset.anexo; });
    });
    if (!anexoInput.value && anexoButtons[0]) { setAnexoActive(anexoButtons[0]); anexoInput.value = anexoButtons[0].dataset.anexo; }

    // ===== Bot√µes ‚ÄúComparar‚Äù
    const compararButtons = document.querySelectorAll('.comparar-btn');
    const compararInput = document.getElementById('comparar');
    function setCompararActive(btn) {
      compararButtons.forEach(b => {
        b.classList.remove('bg-indigo-500','text-white','hover:bg-indigo-600','border-indigo-600');
        b.classList.add('bg-white','text-gray-700','hover:bg-gray-200','border','border-gray-300');
      });
      btn.classList.add('bg-indigo-500','text-white','hover:bg-indigo-600','border-indigo-600');
      btn.classList.remove('bg-white','text-gray-700','hover:bg-gray-200','border-gray-300');
    }
    compararButtons.forEach(button => {
      button.addEventListener('click', (e) => { e.preventDefault(); setCompararActive(button); compararInput.value = button.dataset.comparar; });
    });
    if (!compararInput.value && compararButtons[0]) { setCompararActive(compararButtons[0]); compararInput.value = compararButtons[0].dataset.comparar; }

    // ===== Tabela de atividades
    const tblAtividades = document.getElementById('tblAtividades')?.querySelector('tbody');
    document.getElementById('btnAddAtividade')?.addEventListener('click', ()=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-2 pr-2"><input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="Atividade"></td>
        <td class="py-2 pr-2"><input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="R$ 0,00"></td>
        <td class="py-2 pr-2"><input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="R$ 0,00"></td>
        <td class="py-2 pr-2">
          <select class="w-full p-2 border border-gray-300 rounded">
            <option value="false">N√£o</option>
            <option value="true">Sim</option>
          </select>
        </td>
        <td class="py-2 pr-2">
          <button type="button" class="px-2 py-1 text-xs rounded border border-gray-300 hover:bg-gray-100 btnRemAtv">Remover</button>
        </td>
      `;
      tblAtividades.appendChild(tr);
      tr.querySelector('.btnRemAtv').addEventListener('click', ()=> tr.remove());
    });

    // ===== Monta payload (reutilizado nos dois fluxos)
    function montarPayload(){
      const dados = {
        nome_empresa: document.getElementById('nome_empresa').value || '',
        cnpj: document.getElementById('cnpj').value || null,
        tipo_empresa: document.getElementById('tipo_empresa').value,
        faturamento: parseFloat(document.getElementById('faturamento').value || '0'),
        socio_outra_empresa: document.getElementById('socio_outra_empresa').value,
        cnae: document.getElementById('cnae').value || '',
        municipio: document.getElementById('municipio').value || '',
        prolabore: parseFloat(document.getElementById('prolabore').value || '0'),
        anexo: document.getElementById('anexo').value || '',
        comparar: document.getElementById('comparar').value || '',
        prolabore_ideal: parseFloat(document.getElementById('prolabore_ideal').value || '0'),
        tem_funcionarios: document.getElementById('tem_funcionarios').value,
        folha: parseFloat(document.getElementById('folha').value || '0'),
        icms: parseFloat(document.getElementById('icms').value || '0'),
        empresa_constituida: (document.getElementById('tipo_empresa').value === 'constituida'),
      };

      if (dados.empresa_constituida){
        const socioPerc = document.getElementById('socio_outra_empresa_percentual').value;
        const cnaeImp = document.getElementById('cnae_impeditivo_simples').value;
        const impAberto = document.getElementById('impostos_em_aberto').value;
        const possFunc = document.getElementById('possui_funcionarios').value;

        dados.regime_atual = document.getElementById('regime_atual').value || null;
        dados.cnae_atual = document.getElementById('cnae_atual').value || null;
        dados.cnae_impeditivo_simples = cnaeImp === '' ? null : (cnaeImp === 'true');
        dados.impostos_em_aberto = impAberto === '' ? null : (impAberto === 'true');
        const parseBR = (v)=>{ const n=(v||'').replace(/[R$\s]/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',','.'); return n? Number(n): null; };
        dados.media_faturamento_12m = parseBR(document.getElementById('media_faturamento_12m').value || '');
        dados.estimativa_faturamento_proximo_ano = parseBR(document.getElementById('estimativa_faturamento_proximo_ano').value || '');
        dados.socio_outra_empresa_percentual = socioPerc === '' ? null : parseFloat(socioPerc);
        dados.possui_funcionarios = possFunc === '' ? null : (possFunc === 'true');
        dados.folha_12m_total = parseBR(document.getElementById('folha_12m_total').value || '');

        const atividades = [];
        document.querySelectorAll('#tblAtividades tbody tr').forEach(tr=>{
          const tds = tr.querySelectorAll('td');
          const nome = tds[0].querySelector('input').value;
          const rec12 = tds[1].querySelector('input').value;
          const prox = tds[2].querySelector('input').value;
          const exp  = tds[3].querySelector('select').value === 'true';
          const parseBR2 = (v)=>{ const n=(v||'').replace(/[R$\s]/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',','.'); return n? Number(n): 0; };
          if (nome) atividades.push({ nome, receita_12m: parseBR2(rec12), estimativa_proximo_ano: parseBR2(prox), exportacao: exp });
        });
        dados.separacao_atividades = atividades.length ? atividades : null;
      }
      return dados;
    }

    // ===== SUBMIT: DASHBOARD (POST /analise)
    const tributarioForm = document.getElementById('tributarioForm');
    const btnDashboard = document.getElementById('btnDashboard');
    tributarioForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      btnDashboard.disabled = true;
      statusMessage.textContent = 'Enviando dados para an√°lise (dashboard)...';

      const dados = montarPayload();
      if(!dados.anexo){ statusMessage.textContent = 'Selecione um Anexo do Simples.'; btnDashboard.disabled=false; return; }
      if(!dados.comparar){ statusMessage.textContent = 'Selecione o regime a comparar.'; btnDashboard.disabled=false; return; }

      try{
        const resp = await fetch(`${apiUrlBase}/analise`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(dados) });
        if(!resp.ok){ const err = await resp.json().catch(()=>({detail:'Erro ao analisar dados.'})); throw new Error(err.detail || 'Erro ao analisar.'); }
        const json = await resp.json();
        localStorage.setItem('analiseTributaria', JSON.stringify(json));
        window.location.href = '/dashboard';
        statusMessage.textContent = 'Dashboard aberto.';
      }catch(e){
        console.error(e); statusMessage.textContent = `Erro: ${e.message}`;
      }finally{
        btnDashboard.disabled = false;
      }
    });

    // ===== BOT√ÉO: EXCEL (POST /gerar-planilha)
    const btnExcel = document.getElementById('btnExcel');
    btnExcel.addEventListener('click', async ()=>{
      btnExcel.disabled = true;
      statusMessage.textContent = 'Gerando planilha Excel...';

      const dados = montarPayload();
      if(!dados.anexo){ statusMessage.textContent = 'Selecione um Anexo do Simples.'; btnExcel.disabled=false; return; }
      if(!dados.comparar){ statusMessage.textContent = 'Selecione o regime a comparar.'; btnExcel.disabled=false; return; }

      try{
        const resp = await fetch(`${apiUrlBase}/gerar-planilha`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(dados) });
        if(!resp.ok){ const err = await resp.json().catch(()=>({detail:'Erro ao gerar planilha.'})); throw new Error(err.detail || 'Erro ao gerar planilha.'); }
        const { nome_arquivo } = await resp.json();

        const a = document.createElement('a');
        a.href = `${apiUrlBase}/baixar-planilha/${nome_arquivo}`;
        a.setAttribute('download', nome_arquivo);
        document.body.appendChild(a); a.click(); a.remove();

        statusMessage.textContent = `Download da planilha "${nome_arquivo}" iniciado.`;
      }catch(e){
        console.error(e); statusMessage.textContent = `Erro: ${e.message}`;
      }finally{
        btnExcel.disabled = false;
      }
    });

    // ===== Pessoa F√≠sica (placeholder)
    const irpfForm = document.getElementById('irpfForm');
    const submitPfButton = document.getElementById('submitPfButton');
    irpfForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      submitPfButton.disabled = true;
      statusMessage.textContent = 'Endpoint de IRPF ainda n√£o implementado.';
      setTimeout(()=>{ submitPfButton.disabled=false; }, 1200);
    });
  </script>
</body>
</html>
