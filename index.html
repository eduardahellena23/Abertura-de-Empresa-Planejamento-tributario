<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador de Planejamento Tributário</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #1a202c; }
    .page { display: none; }
    .page-container { z-index: 10; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full page-container">

    <!-- Página principal -->
    <div id="empresaFormPage" class="page" style="display:block">
      <h1 class="text-3xl font-bold mb-6 text-center text-indigo-600">
        Simulador de Planejamento Tributário
      </h1>

      <form id="tributarioForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">Nome da Empresa</label>
          <input id="nome_empresa" class="mt-1 p-3 border border-gray-300 rounded-md" placeholder="Ex.: Minha Empresa LTDA">
        </div>

        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">Município</label>
          <input id="municipio" class="mt-1 p-3 border border-gray-300 rounded-md">
        </div>

        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">RBT12 (Receita Bruta 12m)</label>
          <input id="rbt12" type="number" class="mt-1 p-3 border border-gray-300 rounded-md" placeholder="Ex.: 500000">
        </div>

        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">Folha (12m)</label>
          <input id="folha" type="number" class="mt-1 p-3 border border-gray-300 rounded-md" placeholder="Ex.: 100000">
        </div>

        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">Pro Labore</label>
          <input id="prolabore" type="number" class="mt-1 p-3 border border-gray-300 rounded-md">
        </div>

        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">CNAE (principal)</label>
          <input id="cnae" class="mt-1 p-3 border border-gray-300 rounded-md" placeholder="Ex.: 47.51-2-01">
        </div>

        <!-- CNAEs Secundários -->
        <div class="flex flex-col md:col-span-2">
          <label class="text-sm font-medium text-gray-700">CNAEs Secundários</label>
          <textarea id="cnaes_secundarios" rows="3" class="mt-1 p-3 border border-gray-300 rounded-md" placeholder="62.01-5-01, 73.11-4-00"></textarea>
          <small class="text-xs text-gray-500 mt-1">Separe por vírgula, espaço ou quebra de linha</small>
        </div>

        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">Anexo</label>
          <select id="anexo" class="mt-1 p-3 border border-gray-300 rounded-md">
            <option value="">Selecione...</option>
            <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option>
          </select>
        </div>

        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700">Tipo de Empresa</label>
          <select id="tipo_empresa" class="mt-1 p-3 border border-gray-300 rounded-md">
            <option value="constituida">Constituída</option>
            <option value="abertura">Em abertura</option>
          </select>
        </div>

        <div class="md:col-span-2 flex justify-center mt-4 gap-3">
          <button type="submit" id="btnDashboard" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">
            Ver Dashboard
          </button>
          <button type="button" id="btnExcel" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">
            Baixar Planilha (Excel)
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiBase = "http://127.0.0.1:8000";

    function parseCnaesSecundarios(){
      const raw = document.getElementById('cnaes_secundarios').value || '';
      return raw.split(/[,\s;]+/).map(s => s.trim()).filter(Boolean);
    }

    function montarPayload(){
      const folha = parseFloat(document.getElementById('folha').value || '0');
      return {
        nome_empresa: document.getElementById('nome_empresa').value || '',
        municipio: document.getElementById('municipio').value || '',
        tipo_empresa: document.getElementById('tipo_empresa').value || 'constituida',
        rbt12: parseFloat(document.getElementById('rbt12').value || '0'),
        prolabore: parseFloat(document.getElementById('prolabore').value || '0'),
        folha: folha,
        folha_12m_total: folha,
        cnae: document.getElementById('cnae').value || '',
        cnaes_secundarios: parseCnaesSecundarios(),
        anexo: document.getElementById('anexo').value || '',
        comparar: '',
        socio_outra_empresa: 'nao'
      };
    }

    document.getElementById('tributarioForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const payload = montarPayload();
      try{
        const resp = await fetch(`${apiBase}/analise`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        localStorage.setItem('analiseTributaria', JSON.stringify(json));
        localStorage.setItem('ultimoPayload', JSON.stringify(payload));
        location.href = '/dashboard';
      }catch(err){
        alert('Erro ao gerar análise: '+err.message);
      }
    });

    document.getElementById('btnExcel').addEventListener('click', async ()=>{
      const payload = montarPayload();
      try{
        const resp = await fetch(`${apiBase}/gerar-planilha`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if(json.download_url_query){
          window.open(`${apiBase}${json.download_url_query}`, '_blank');
        } else {
          alert('Erro: '+JSON.stringify(json));
        }
      }catch(err){
        alert('Falha ao gerar planilha: '+err.message);
      }
    });
  </script>
</body>
</html>
